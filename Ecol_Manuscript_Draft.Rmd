---
title: "Challenges to transboundary fisheries management in North America under climate change"
author: "Juliano Palacios-Abrantes^1^ U. Rashid Sumaila^1^ William W. L. Cheung^1^"
subtitle: "[THIRD DRAFT]"
date: "^1^ Institute for the Oceans and Fisheries, University of British Columbia, Vancouver, Canada"
output:
  word_document: default
  pdf_document: default
bibliography: Ecol_Analysis/Oceans_Canada_Biblio.bib
editor_options: 
  chunk_output_type: console
csl: Ecol_Analysis/harvard.csl
---
  
```{r setup, eval=T, echo=F, warning=F,message=F, results='hide'}

#### READ ME !!! ####
# Run this chunk before knit so you make sure you have all pkgs installed in R

ipak <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg)) 
    install.packages(new.pkg, dependencies = TRUE,repos = "http://cran.us.r-project.org")
  sapply(pkg, require, character.only = TRUE)
}


#### Library ####
packages <- c(
  "readxl", # Read dataframe
  "dplyr", # Data manipulation
  "tidyr", # Data manipulation
  "ggplot2", #Nice grpahs and spatial analysis
  "RColorBrewer",
  "data.table",
  "ggrepel",
  "sf",
  # "sp",
  # "rgdal", #Spatial analysis 
  "tools"#, #Spatial analysis 
  # "png", # For reading plots in chunk codes
  # "grid" # For reading plots in chunk codes
)

ipak(packages)

##________________________________________________##

# source("/Users/jpalacios/Documents/UBC/Oceans_Project/Distribution/Functions/DBEM_imp_F.R") #Imports a single species


ggtheme_plot <- function() {
  theme(
    plot.title = element_text(size = rel(1), hjust = 0, face = "bold"),
    panel.background = element_blank(),
    strip.background = element_blank(),
    # strip.text       = element_text(size = base_size, face = "italic"),
    panel.border     = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank(),
    axis.ticks = element_blank(),
    axis.text.x = element_text(size = 14,
                               angle = 0,
                               face = "plain"),
    axis.text.y = element_text(size = 14),
    axis.title = element_text(size = 14),
    legend.key = element_rect(colour = NA, fill = NA),
    legend.position  = "top",
    legend.title = element_text(size = 16),
    legend.text = element_text(size = 14),
    strip.text.x = element_text(size = 10, colour = "black"),
    strip.text = element_text(size = 18)
  )
}

ggtheme_map <- function(base_size = 9, Region = "NA") {
  
  theme(text             = element_text(#family = "Helvetica",
    color = "gray30", size = base_size),
    plot.title       = element_text(size = rel(1.25), hjust = 0, face = "bold"),
    panel.background = element_blank(),
    panel.border     = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_line(color = "transparent"),
    strip.background =element_rect(fill = "transparent"),
    strip.text.x = element_text(size = 18, colour = "black",face= "bold.italic", angle = 0),
    axis.line        = element_blank(), # element_line(colour = "grey30", size = .5))
    axis.ticks       = element_blank(),
    axis.text        = element_blank(),
    axis.title       = element_blank(),
    legend.key       = element_rect(colour = NA, fill = NA, size = 4),
    legend.position = "bottom",
    legend.key.width =unit(7,"line")
  )
}


  
  # Current time
Beg_In <- paste(2005); Beg_In
Beg_End <- paste(2014); Beg_End

# Mid century
Mid_In <- paste(2041);Mid_In # 2046
Mid_End <- paste(2060);Mid_End

# End Century
End_In <- paste(2081);End_In # 2090
End_End <- paste(2099);End_End
```

# Abstract 

Climate change is shifting the distribution of fish stocks that straddle between Exclusive Economic Zones (EEZ), challenging transboundary fisheries management. In this paper, we examine the projected sharing of jointly managed transboundary fish stocks between the EEZs of Canada and the United States. We hypothesize that ocean warming will alter the sharing of fish stocks between the two countries, and that such changes will intensify under a high carbon emission scenario impacting the stock-share ratio of different stocks. Firstly, we projected changes in potential catch of 33 transboundary stocks of North America in the 21^st^ century based on multiple Earth system models’ simulations and species distribution models, under two climate change scenarios. We then look at the specific cases of the International Pacific Halibut Commission that manages pacific halibut (*Hippoglossus stenolepis*) and a resource sharing agreement in the Gulf of Maine for cod (*Gadus morhua*), haddock (*Melanogrammus aeglefinus*) and yellowtail flounder (*Limanda ferruginea*). Results show that, even under a low emission scenario, most transboundary fish stocks sharing ratios, i.e., the proportion of the total catch of a fish stock taken by a given country, will change by 2050 relative to present in the direction as expected from the effects of ocean warming. The overall reduction in catch potential, in addition to the changes in stock-share will further exacerbate trade-offs between changes in species catch potential. Such trade-offs in the Atlantic and Pacific regions will be amplified if a high emission scenario is followed, relative to a low carbon emission scenario. Our paper highlights the challenges that transboundary fisheries management will face as species shift their current distribution under a changing climate.[^Acknowledgements]


Keywords: *Transboundary fisheries management; climate change; joint fisheries management; species distribution shift*

[^Acknowledgements]: This is a product of the *OceanCanada* Partnership funded by the Social Sciences and Humanities Research Council of Canada.

# INTRODUCTION

<!-- ##### First paragraph of paper summary -->
Transboundary fisheries are defined as fish stocks that move freely between (*i*) Countries economic exclusive zones (EEZs) and (*ii*) between EEZs and the high seas (also called straddling stocks) [@Song:2017iua]. The management of transboundary stocks can be analized using game theory, as often, success depends on effective cooperation between parties [@Munro:2002uf; @Sumaila:2013hv]. Therefore, in 1985, the United Nations incentivized actions to cooperate on the management of transboundary fisheries through the Law of the Seas (UNCLOS) [@UnitedNations:1986tl]. Today, an estimated 347 [@Teh:2015gd] to 1500 [@Caddy:1997ue] fish stocks cross national borders, some of them jointly managed by two or more countries. These stocks are responsible for almost 50% of these countries total fish catches [@Teh:2015gd]. Transboundary stocks such as salmon (*Oncorhynchus spp.*), Pacific halibut (*Hippoglossus stenolepis*), and Atlantic cod (*Gadus morhua*) are of utmost importance for Canada and the United States (US). Management of these stocks is extremely hard due to the participation of several fishing “players”, different countries and sometimes jurisdictions within a country, the migration patterns of the stock, and their abundance fluctuation within space and time [@Munro:2002uf].

<!-- ##### Climate Change and Transboundary Fisheries -->

The ocean is getting warmer [@Rheim:2013fv], less oxygenated [@Schmidtko:2017cl], and increasing in acidity [@Ross:2011kd]. To cope with these changes in ocean biophysic properties, marine species, including transboundary fish stocks, have been shifting their distribution towards the poles and/or deeper waters [@Poloczanska:2016kk]. As climate change reshapes the ocean's environment worldwide [@Gattuso:2015jz], transboundary fisheries' delicate governance is threatened as new migration patterns may arise [@Miller:2013iv; @Pinsky:2018cb], historic distribution and abundances might shift [@Cheung:2010dt], and species basic natural traits may modify [@Pauly:2017hpa]. Catches of shared stocks like tropical tunas, have significantly increased in subtropical regions of the Atlantic and western Pacific Oceans [@MonllorHurtado:2017cm]. Multiple transboundary species in North America have been observed to shift in distribution following changes in optimal conditions such as sockeye salmon (*Oncorhynchus nerka*) [@McDaniels:2010vn], Atlantic cod [@Pershing:2015gq], and flounders [@Pinsky:2012kq]. Moreover, these shifts are projected to continue towards the end of the 21^st^ century [@Cheung:2018hz] at a rate of tens to hundreds of km and/or tens of meters per decade towards the poles and/or deeper waters, respectively, although there will be regional variations [@Morley:2018fn]. As a result, some countries or management jurisdictions may see more transboundary stocks and their catches shifting into their waters while others will stand to lose [@Miller:2013iv; @Pinsky:2018cb]. Nevertheless, management rules for shared stocks (e.g. quota or spatial delimitation) are often determined based on current and historic knowledge of the stock's distribution and do not consider future shifts in distributions [@FredstonHermann:2018kp]. In addition, many international treaties do not directly consider climate change in their management scheme, despite evidence of target species shifting their distribution.

<!-- ##### Past Conflicts of shifting stocks -->

The shifts in distribution of transboundary fish stocks would impact the economics of their fisheries [@Lam:2016dy; @Pinsky:2012kq; @Sumaila:2011bq, @Sumaila:2019gh], and create international disputes in the sharing of fish stocks between nation's EEZs [@Munro:2002uf; @Spijkers:2017ij]. As climate change alters the sharing of fish stocks between countries to an extent that is beyond historical changes, existing policies and governance structures may not be able to cope with these changes. Consequently, countries may not be satisfied with the sharing or allocation of access to resources, leading to international disputes [@Pinsky:2018cb]. Disputes over Pacific salmon between Canada and the US arose in the 1990s because of climate-related changes in stock abundance and migratory behavior [@Miller:2013iv; @Munro:2002uf; @Song:2017va]. Currently, Europe is involved in an unsolved dispute over *Scomber scombrus* known as the "mackerel wars". The conflict erupted in 2007 when the stock shifted their distribution from the Norwegian Sea towards northern and western regions of the Nordic Seas, consequently spreading into Iceland's national waters [@Spijkers:2017ij].

<!-- ##### Bring it home, treaties between CA/US -->

Transboundary fisheries between Canada and the US offer a unique lens to understand the extent to which climate-induced distributional shifts will challenge the future sustainability of these fisheries. Canada and the US have a long history of fisheries cooperation [@Song:2017va]. They participate in diverse, jointly managed, commercial transboundary stocks through various fisheries management organizations [@Merten:2015tu]. Cooperation schemes vary by fisheries stocks, regulatory areas, legal terms of agreement, and management measures, among others (Fig. 1). In the Atlantic coast, Canada and the US are part of the Northwest Atlantic Fisheries Organization (NAFO) that oversees the management of 19 stocks of 11 transboundary species (although around 41 taxa are fished within Canadian and US waters) from southern Gulf of Maine to Greenland[^NAFO]. Within NAFO's region 5Z, Canada and the US have a "Resource Sharing Understanding" (hereafter referred to "GoM agreement") to set catch-limits of Atlantic cod (*Gadus morhua*), haddock (*Melanogrammus aeglefinus*) and, yellowtail flounder (*Limanda ferruginea*) [@Soboil:2006gw; @CIA:2017uta]. In the Pacific coast, Pacific halibut (*Hippoglossus stenolepis*) is managed under the International Pacific Halibut Commission (IPHC) [@IPHCSecreatriat:2017uz]. All five salmon species (chinook, *Oncorhynchus tshawytscha*; chum, *O. keta*; coho, *O. kisutch*; pink, *O. gorbuscha*; and sockeye *O. nerka*), are managed by the Pacific Salmon Commission [@PSC:2017tb]. Finally, under the Pacific Whiting Treaty, Canada and the United states jointly manage the coastal stock of this Pacific hake species (*Merluccius productus*) [@Merten:2015tu].

[^NAFO]: Northwest Atlantic Fisheries Organization, Available at https://www.nafo.int/Science/Species

```{r Study_Area_Map, eval = F, echo = F, warning=F, message=F}

Countries <- c("Canada","United States")

### North America Initial Map ####

path_world <- "~/Documents/Github/Oceana_LA/international/information/raw_databases/Spatial/TM_WORLD_BORDERS-0.3"
file_name <- "TM_WORLD_BORDERS"

World_Land_sf <- st_read(dsn = path_world, 
layer = file_path_sans_ext(file_name)
) %>% 
st_transform(crs = 3832)

# names(World_Land_sf)

North_America_Land <- World_Land_sf %>% 
filter(NAME %in% Countries) %>% 
st_transform(crs = 3832)

# head(North_America)

# ggplot(North_America_Land) +
#   geom_sf() +
#   coord_sf(ylim = c(3051701,11528813)
#   )


### North America EEZs Map ####

path_eez <- ("/Users/jpalacios/Documents/R CODE/Spatial_Analysis/Data/World_EEZ_v10_2018")
#The File
fnam_eez <- "eez_v10.shp"

eez_world_sf <- st_read(dsn = path_eez, 
                        layer = file_path_sans_ext(fnam_eez)
) %>% 
  st_transform(crs = 3832)

Nort_America_EEZ <- eez_world_sf %>% 
filter(Territory1 %in% Countries)

# Testing
ggplot(Nort_America_EEZ) +
geom_sf()

# Testing together

ggplot(North_America_Land) +
  geom_sf() +
  geom_sf(data = Nort_America_EEZ, colour = "black") +
  coord_sf(ylim = c(3051701,11528813)
  )

#### IPHC Regulatory Areas ####

path_IPHC <- ("/Users/jpalacios/Documents/UBC/Oceans_Project/Distribution/Data/IPHC/IPHC_RegulatoryAreas/")

# The Canada file
fnam_IPHC_C <- "IPHC_RegulatoryAreas_CAN"


IPHC_Reg_C <- st_read(dsn = path_IPHC, 
                      layer = file_path_sans_ext(fnam_IPHC_C)
) %>% 
  select(
    ID,
    Country = COUNTRY,
    State = PROV_EN,
    RegArea
  ) %>% 
  mutate(Comments = "NA") %>% 
  st_transform(crs = 3832)

# 4326 use this to merge with DBEM data
# 3832 use this to center the map and plot

# ggplot(IPHC_Reg_C) +
# geom_sf()
  

# The US File
fnam_IPHC_US <- "IPHC_RegulatoryAreas_US"

IPHC_Reg_US <- st_read(dsn = path_IPHC,
                       layer = file_path_sans_ext(fnam_IPHC_US)
) %>%
  st_transform(crs = 3832)

# head(IPHC_Reg_US)
ggplot(IPHC_Reg_US) +
  geom_sf()

### Combine both shapefiles

IPHC_Reg <- rbind(IPHC_Reg_US,IPHC_Reg_C)

ggplot(IPHC_Reg) +
  geom_sf()

##### NAFO Regulatory Area ####

path_NAFO <- ("/Users/jpalacios/Documents/UBC/Oceans_Project/Distribution/Data/Spatial/NAFO")
#The File
fnam_NAFO <- "Divisions"

NAFO_Area <- st_read(dsn = path_NAFO,
                     layer =file_path_sans_ext(fnam_NAFO))%>% 
  st_transform(crs = 3832) 

Zones <- c(
  "5Ze",
  # "5Zw",
  "5Y",
  "4X"
)

NAFO_5z <- NAFO_Area %>% 
filter(ZONE %in% Zones)

# head(NAFO_5z)

ggplot() +
geom_sf(data = North_America_Land,
        fill = "lightgrey",
        colour = "black") +
  ggtheme_map()
  

#### The final Map ####

# Homonize collors 
brewer.pal(name="Set2",5)

# Canada "#grey80"
# US "#grey40", 
# NAFO "#66CC99"
# IPHC #f01282

#North America point of view

North_A <- ggplot() +
  geom_sf(data = North_America_Land, 
          aes(fill = NAME),
          colour = "black"
  ) +
  geom_sf(data = IPHC_Reg, 
          aes(fill = "IPHC") ,
          colour = "black"
  ) +
  geom_sf(data = NAFO_5z, 
          aes(fill = "NAFO"),
          colour = "black"
  ) +
  ggtheme_map() +
  scale_fill_manual("Region",
                    breaks = c("Canada","IPHC","NAFO", "United States"), 
                    values=c("grey80","#CC6666","#66CC99","grey40")
                    ) +
  theme(legend.position = "right")

Path_Save <- "/Users/jpalacios/Documents/UBC/Oceans_Project/Manuscript/Results/Others/"

ggsave("Fig1_NA.png",
       plot = North_A,
       width = 6,
       height = 5,
       units = "in",
       path = Path_Save)

#NAFO #

NAFO <- ggplot() +
  geom_sf(data = NAFO_5z, #NAFO regions
          aes(fill = "NAFO"),
          colour = "black"
  )+
  geom_sf_label(data = NAFO_5z, # RegAreas labels
                aes(
                  label = ZONE#,
                  # fill = "NAFO"
                ),
                alpha = 0.5
  ) +
  geom_sf(data = North_America_Land, # North America Land
          aes(fill=NAME),
          colour = "black"
  ) +
  coord_sf(ylim = c(5951701,4728813),
           xlim = c(15373019,16573019)
  ) +
  # scale_fill_brewer("Region",palette = "Set2") +
  theme(
    panel.background = element_blank(),
    panel.border     = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_line(color = "transparent"),
    legend.position = "bottom",
    axis.title = element_blank()
  ) +
  scale_fill_manual("Region",breaks = c("Canada", "NAFO", "United States"), 
                    # values = c("#E78AC3","#A6D854","8DA0CB")
                    values=c("grey80", "#66CC99", "grey40")
                    ); NAFO



# Save plot for manuscrip
ggsave("Fig1_NAFO.png",
       plot = NAFO,
       width = 6,
       height = 5,
       units = "in",
       path = Path_Save)


# IPHC

IPHC_Reg$RegArea <- gsub("Closed Area","CA",IPHC_Reg$RegArea)

IPHC <- ggplot() +
  geom_sf(data = IPHC_Reg,
          aes(fill = "IPHC"),
          colour = "black"
  ) + 
  geom_sf(data = North_America_Land, # North America Land
          aes(fill=NAME),
          colour = "black"
  ) +
  geom_sf_label(data = IPHC_Reg, # RegAreas labels
                aes(
                  label = RegArea#,
                  # fill = Percentage
                ),
                alpha = 0.5
  ) +
  
  coord_sf(xlim = c(1963800, 10041910), # Subsets north america
           ylim = c(3651701,9728813)
  ) +
  theme(
    panel.background = element_blank(),
    panel.border     = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_line(color = "transparent"),
    legend.position = "bottom",
    axis.title = element_blank()
  ) +
  scale_fill_manual("Region",breaks = c("Canada", "IPHC", "United States"), 
                    values=c("grey80", "#CC6666", "grey40")
                    )

# Save plot for manuscrip
ggsave("Fig1_IPHC.png",
       plot = IPHC,
       width = 6,
       height = 5,
       units = "in",
       path = Path_Save)

```

![Fig 1. Map of North America with the regulatory areas of the IPHC and the NAFO sub-region related to the Gulf of Main agreement](./Results/Fig1.png)


It is expected that climate induced shifts in stock distribution affect the rules in place that keeps these treaties alive. Therefore, the main objective of this paper is to assess the level of exposure of international fisheries management treaties between Canada and the US to climate change impacts through shifts in stock distributions. Specifically, we rely on a species distribution model and scenario planning to project the changes in the distribution of 33 fish stocks jointly managed by Canada and the US. Moreover, we use two specific treaties as case studies (IPHC and the GoM agreement) to explore the potential impacts that climate change will have on selected transboundary fisheries management. Finally, we explore similar situations around the world and identify opportunities to improve the adaptability of transboundary fisheries management to climate change in North America. Despite an overall expectation of species following a poleward shift, important geographic features (e.g. Gulf of Alaska representing a latitudinal block), geo-political (e.g. the localization of Alaska in reference to Canada and the contiguous states), and management rules (e.g. quota allocations, spatial management rules) may play an important role in the redistribution of benefits. Understanding these stocks shifts will shed a light on future conditions and inform decision makers on the paths to follow under a changing climate.


# METHODS

#### Study Area and Fisheries

The current study focuses on transboundary fisheries jointly managed by Canada and the US for both the Atlantic and the Pacific coasts. The analysis was carried out within the 200 nautical miles of both nation's EEZ from the Gulf of Mexico to The Labrador Sea in the Atlantic, and from California to Chukchi Sea, in the Pacific coast (Fig. 1). Subsets of the total area were carried for both the IPHC and the Gulf of Maine agreement. For the IPHC, we used the most updated spatial regulatory data provided by the Commission [@IPHCSecreatriat:2017uz]. For this specific case, we considered Alaska as a separate entity, the US contiguous states as a second one (Washington, Oregon and California), and lastly British Columbia (Canada). For the GoM agreement we used NAFO's divisions 5Y, 5Ze, and 4X within latitudes 46.2°N and 41.5°S, and longitudes -72°W and -64°E (Fig. 1).

```{r Spatial_data, eval = T, echo = F, warning=F, message=F, results = 'hide'}

# List of DBEM INDEX within the EEZ
#Data provided by Vicki Lam
EEZIDs_List <- read_excel("./Data/Spatial/Updated_EEZList_17June2016.xlsx")
EEZ_CellID <- read_excel("./Data/Spatial/EEZ_CellID.xlsx")
colnames(EEZ_CellID) <- c("EEZID","INDEX")

# DBEM Coordinate system
Coor <- fread("./Data/Spatial/Lon_Lat_DBEM.txt",header = FALSE)
colnames(Coor) <- c("INDEX","Longitude","Latitude")

### Select EEZs
EEZs <- c(
  "Canada (Pacific)",
  "Canada (Arctic)",
  "USA (West Coast)",
  "USA (Alaska, Arctic)",
  "USA (Alaska, Subarctic)",
  "Canada (Arctic)",
  "Canada (East Coast)",
  "USA (East Coast)"
)

### North America Initial Map ####

path_world <- "./Data/Spatial/TM_WORLD_BORDERS"
file_name <- "TM_WORLD_BORDERS"

World_Land_sf <- st_read(dsn = path_world, 
                         layer = file_path_sans_ext(file_name)
) %>% 
  st_transform(crs = 4326)

# names(World_Land_sf)

North_America_Land <- World_Land_sf %>% 
  filter(NAME %in% c("Canada","United States")) %>% 
  st_transform(crs = 3832) # 4326 use this to merge with DBEM data
# 3832 use this to center the map and plot

#### _____________________TEST _____________________ #
# head(North_America_Land)
# ggplot(North_America_Land) +
#   geom_sf() +
#   coord_sf(xlim = c(-120, -179),
#            ylim = c(30,70)
#   )
##__________________________________________ #

### North America EEZs Map ####

path_eez <- "./Data/Spatial/World_EEZ_v10_2018"
#The File
fnam_eez <- "eez_v10.shp"

eez_world_sf <- st_read(dsn = path_eez, 
                        layer = file_path_sans_ext(fnam_eez)
                        ) %>% 
  st_transform(crs = 4326)# 4326 use this to merge with DBEM data
# 3832 use this to center the map and plot


#### _____________________TEST _____________________ #
# head(eez_world_sf)
### Test this map
# ggplot(ezz_North_America) +
#   geom_sf()
##__________________________________________##


#### IPHC Regulatory areas ####

## Correct DBEM for Alaska ####
IHPC_EEZs <- c(
  "Canada (Pacific)",
  # "Canada (Arctic)"
  "USA (West Coast)",
  "USA (Alaska, Arctic)",
  "USA (Alaska, Subarctic)"#,
  # "Russia (Far East)"
)

IPHC_EEZsID <- EEZIDs_List %>% 
  filter(Name %in%IHPC_EEZs) %>% 
  left_join(EEZ_CellID,
            by = "EEZID") %>% 
  left_join(Coor,
            by = "INDEX")

# "Move" the map so results are not in the other side of the world and it matches the projection I want
IPHC_Coor_Corrected <- IPHC_EEZsID %>% 
  filter(Longitude > 0) %>% 
  mutate(Longitude = Longitude-360)

IPHC_Coor_Corrected <- IPHC_EEZsID %>% 
  filter(Longitude < 0) %>% 
  bind_rows(IPHC_Coor_Corrected) %>% 
  filter(Latitude > 25) 

# Create new column to merge with shapefiles

IPHC_Coor_Corrected_Clean <- IPHC_Coor_Corrected %>% 
  mutate(
    State = ifelse(Name == "Canada (Pacific)", "British Columbia",
                   ifelse(Name == "USA (West Coast)","WAORCA","Alaska"))
  ) %>% 
  select(
    # State,
    INDEX,
    longitude = Longitude,
    latitude = Latitude)


# Now we load IPHC shapefiles ####
path_IPHC <- "./Data/Spatial/IPHC_RegulatoryAreas"

# The Canada file
fnam_IPHC_C <- "IPHC_RegulatoryAreas_CAN"


IPHC_Reg_C <- st_read(dsn = path_IPHC, 
                      layer = file_path_sans_ext(fnam_IPHC_C)
) %>% 
  select(
    ID,
    Country = COUNTRY,
    State = PROV_EN,
    RegArea
  ) %>% 
  mutate(Comments = "NA") %>% 
  st_transform(crs = 4326)

# 4326 use this to merge with DBEM data
# 3832 use this to center the map and plot

#### _____________________TEST _____________________##
# head(IPHC_Reg_C)
# ggplot(IPHC_Reg_C) +
# geom_sf()
##_________________________________________________##
# The US File
fnam_IPHC_US <- "IPHC_RegulatoryAreas_US"

IPHC_Reg_US <- st_read(dsn = path_IPHC, 
                       layer = file_path_sans_ext(fnam_IPHC_US)
) %>% 
  st_transform(crs = 4326) 

#### _____________________TEST _____________________ #
# head(IPHC_Reg_US)
# ggplot(IPHC_Reg_US) +
#   geom_sf()
##_________________________________________________##

### Combine both shapefiles

IPHC_Reg <- rbind(IPHC_Reg_US,IPHC_Reg_C)

#### _____________________TEST _____________________ #
# head(IPHC_Reg,12)
# tail(IPHC_Reg)
# unique(IPHC_Reg$State)

# It's going to take a while... 
# ggplot(IPHC_Reg) +
#   geom_sf()
##_________________________________________________##


# Now join the Shapefile with the DBEM lat/long dataset

# Convert DBEM to sf
IPHC_Coor_sf = st_as_sf(IPHC_Coor_Corrected_Clean,
                        coords = c("longitude", "latitude")) %>% 
  st_set_crs(4326) %>% # to match shapefiles
  st_transform(4326) # to match shapefiles

# head(IPHC_Coor_sf)

# Merge DBEM sf to polygons
IPHC_Reg_DBEM <- st_join(IPHC_Reg,
                         IPHC_Coor_sf, join = st_contains) %>% 
  filter(!is.na(INDEX)) %>%
  arrange(INDEX) 
# %>% 
#   st_transform(3832) # Go back to original projection otherwise doesnt like to plot

IPHC_Reg_DBEM_df <- as.data.frame(IPHC_Reg_DBEM) %>% 
  select(INDEX,RegArea)

#### _____________________TEST _____________________ #
# head(IPHC_Reg_DBEM_df)
# IPHC_Reg_DBEM_df %>% 
#   arrange(INDEX) %>% 
# head()
##_________________________________________________##


### STOP 
## Go to the results and now estimate the %change by region using IPHC_Reg_DBEM_df then, convert it to sf and merge it with IPHC_Reg


# Gulf of Maine ####
#### NAFO data ####


path_NAFO <- "./Data/Spatial/NAFO/"
#The File
fnam_NAFO <- "Divisions"

NAFO_Area <- st_read(dsn = path_NAFO,
                     layer =file_path_sans_ext(fnam_NAFO)
                     )


Zones <- c(
  "5Ze",
  # "5Zw",
  "5Y",
  "4X"
)

NAFO_5z <- NAFO_Area %>% 
  filter(ZONE %in% Zones)

#### _____________________TEST _____________________ #
# head(NAFO_5z)

# ggplot(NAFO_5z) +
# geom_sf()
# geom_sf(aes (fill = ZONE))
##_________________________________________________##


### Atlantic EEZ polygon (I don't think we need this for now) ####

Atlantic_EEZs <- c(
  "Canada (Arctic)",
  "Canada (East Coast)",
  "USA (East Coast)"
)
 
Atlantic_EEZsID <- EEZIDs_List %>%
  filter(Name %in% Atlantic_EEZs) %>%
  left_join(EEZ_CellID,
            by = "EEZID") %>%
  left_join(Coor,
            by = "INDEX")

### Atlantic DBEM Data ####

GB_Coor <- Coor %>% 
  filter(INDEX %in% Atlantic_EEZsID$INDEX) %>% 
  mutate(one = 1) 

# Atlantic Land polygon ####

Countries <- c(
  "Canada",
  "United States"
)

### EEZ GM ####
eez_GM <- eez_world_sf %>% 
  filter(Territory1 %in% Countries)

#### _____________________TEST _____________________ #
# ggplot() +
#   geom_sf(data = eez_GM) +
#   coord_sf(xlim = c(-71.0592, -63.33333),
#            ylim = c(40.5,45.9759)
#            )
##_________________________________________________##

GM_Land <- World_Land_sf %>% 
  filter(NAME %in% Countries)

```

The species analyzed (**Table A2.1**) were selected based on five treaties in both the Atlantic and Pacific coast of North America (Table 1). All species under the IPHC, PSC, WT, and the GoM agreement were analyzed as these treaties are management agreements between Canada and the US. However, in the case of NAFO, their management covers over 41 taxa and its governance extends to international waters and the EEZ of Greenland. Therefore, a subset of 26 species reported was made based on those fished in NAFO regions that fall within the EEZs of Canada and the US (NAFO subareas 2's, 3's with the exception of 3M and 3N and limited to the EEZ, 4's,5's and 6 A,B, and C.) [@NAFO]. Data related to fisheries was gathered from the *Sea Around Us* from 1951 to 2014 [@Zeller2016].

```{r Treaties_Table, eval = T, echo = F}


# Foot note
fn <- "*These species are also part of NAFO"

data.table::data.table(Treaty =
                         c("International Pacific Halibut Coomission (IPHC)",
                           "Pacific Salmon Coomission (PSC)",
                           "Pacific Whiting Treaty (PWT)",
                           "Northwest Atlantic Fisheries Organization (NAFO)",
                           "Gulf of Main's Agreement (GoM Agreement)"),
                       Species =
                         c(1,
                           5,
                           1,
                           26,
                           "3*"),
                       Coast =
                         c("Pacific",
                           "Pacific",
                           "Pacific",
                           "Atlantic",
                           "Atlantic")
) %>% 
  kable("latex",
        caption = "Treaties and number of species included in the current analysis."
        ) %>% 
  add_footnote(fn)
```

#### Projecting Future Species Distribution

We used a Dynamic Bioclimatic Envelope Model (DBEM) to project the distribution of species from 2015 to 2100, under two scenarios of climate change [@Cheung:2016hf; @Cheung:2016jd]. The DBEM algorithm integrated ecophysiology, habitat suitability with spatial population dynamics of exploited fishes and invertebrates to project shifts in abundance, and potential fisheries catches  under climate change. The algorithm predicted species distribution based on depth range, latitudinal range, habitat preferences and an index of species association with major habitat types to estimate changes in abundance distribution over a 0.5' x 0.5' grid of the world oceans. For each grid cell and time step, the model then calculated species carrying capacity according to sea surface temperature, salinity, oxygen content, sea ice extent (for polar species) and bathymetry, as well as the species preferences to these conditions. It then incorporated the intrinsic population growth, settled larvae, and net migration of adults from surrounding cells using an advection-diffusion-reaction equation. Finally, the model also simulated the effects of changes in temperature and oxygen content on growth of individuals [@Cheung:2013gk]. Ultimately, the model simulates spatial and temporal population dynamics, and estimates a proxy of maximum sustainable yield (MSY) by applying fishing at MSY level for each grid cell, hereafter referred as maximum catch potential (MCP).

The DBEM was projected using three earth system models (ESM), the Geophysical Fluid Dynamics Laboratory Earth System Models 2M (GFDL)[^GFDL], the Institute Pierre Simon Laplace Climate Model 5 (IPSL-CM5)[^IPSL], and the Max Planck Institute for Meteorology Earth System Model (MPI)[^MPI]. Each model was downscaled to match the DBEM 0.5' x 0.5' grid using the nearest neighbor method, and in some cases, bilinear interpolation [@Cheung:2016hf]. Finally, we used the model outputs for two scenarios of the Intergovernmental Panel on Climate Change (IPPC)-Representative Concentration Pathways (RCP); 2.6 (RCP 2.6) and 8.5 (RCP 8.5) representing a low greenhouse gas emission (strong mitigation) and a high greenhouse gas emission (business-as-usual) scenario, respectively [@IPCC:2014bz]. To estimate model robustness and capture the structural uncertanty build within ESM models we averaged the DBEM results for all three models ($\mu±\sigma$) and marked regions where at least one ESM disagree with the rest.

[^GFDL]: More information related to the Geophysical Fluid Dynamics Laboratory Earth System Models 2M can be found at www.gfdl.noaa.gov
[^IPSL]: More information related to the Institute Pierre Simon Laplace Climate Model 5 can be found at www.icmc.ipsl.fr/
[^MPI]: More information related to the Max Planck Institute for Meteorology Earth System Model can be found at www.mpimet.mpg.de/en/science/models/

```{r Data_Loading_For_DBEM, eval = F, echo = F, warning = F ,message = F}

###------------------------------- ###
#### Chunk to be ran with Drobo ###
###------------------------------- ###

# Species data (Names, treaties, etc)
# DBEM exploited species list 
exploited_species_list <- fread("/Volumes/DATA/PROJECTION exploited species ENM/exploited_species_list.csv")

# IPHC and GB species
Selected_Species <- fread("~/Documents/UBC/Oceans_Project/Distribution/By Cell/Cell_Data/List_Species.csv")

# NAFO Species
# This is the subset of species Fished on canada and US waters of all NAFO's species list
NAFO_Species <- read.csv("~/Documents/UBC/Oceans_Project/Distribution/DBEM/Data/NAFO_Species.csv") %>%
  mutate(Treaty = "NAFO")



```

```{r DBEM_Data_For_All, eval = F, echo = F, warning = F, message = F}

###------------------------------- ###
#### Chunk to be ran with Drobo ###
###------------------------------- ###

All_Species <- exploited_species_list %>% 
  # filter(TaxonName  %in% c("Hippoglossus stenolepis","Anoplopoma fimbria")) %>% 
  filter(TaxonName %in% NAFO_Species$TaxonName) %>%
  mutate(Treaty = "NAFO") %>% 
  bind_rows(Selected_Species) %>% 
  filter(! duplicated(TaxonName)) %>% # Removes duplicated
  select(TaxonName,
         TaxonKey,
         CommonName,
         Treaty)


# For suplement Material ####
# Suplemental_table <- All_Species %>% 
#   select(-TaxonKey) %>% 
#   mutate(Treaty = ifelse(TaxonName %in% NAFO_Species$TaxonName,"NAFO",
#                          ifelse(TaxonName %in% c("Hippoglossus stenolepis",
#                                                  "Anoplopoma fimbria"),
#                                 "IPHC",
#                                 "PSC")
#                          )
#   ) %>% 
#   rename("Scientific name" = TaxonName,
#          "Common name" = CommonName) 
# 
#   write.csv(Suplemental_table,
#             "Final_Species_List.csv",
#             row.names = F)

#_____________________________END SUPLEMENTAL TABLE_______________________________#

Models <- c(
  "GFDL26F1",
  "GFDL85F1",
  "IPSL26F1",
  "IPSL85F1",
  "MPI26F1",
  "MPI85F1"
)


for(m in 1:length(Models)){
  # for(s in 1:2){ #For tensting models
  for(s in 1:nrow(All_Species)){
    
    # Imports all data once# 
    
    x <-dbem_Import(All_Species[s,2],# Include Treaties information
                    2005,
                    2099,
                    Model = Models[m],
                    Data_Type= "Catch"
    )
    
    
    # } # For testing the dbem_Import function
    
    
    ### If statement for abstent species ##
    
    if(length(x >= 1)){
      
      # Merging with lat/long ###
      Spp_Pro <- x %>% 
        left_join(Coor,
                  by = "INDEX")
      
      # If statement for those species not found within national EEZ
      if(nrow(Spp_Pro) <= 1){
        
        print("No data within Area Selected")
        
      }else{
        
        # Include Species Name
        Spp_Pro$Species <- paste(All_Species[s,1])
        # Include Treaties information
        Spp_Pro$Treaty <- paste(All_Species[s,4])
        
        Spp_Pro_I <- as.data.table(Spp_Pro)
        
        # Groups all species together in one database
        if(s == 1){
          Data_P <- copy(Spp_Pro_I) # <- copies the previouse data.table
        }else{
          setkey(Data_P, # <- sets the data.table as "reference" ?setkey
                 Species); setkey(Spp_Pro_I,
                                  Species);
          list <- list(Data_P, # <- creates a list to merge the tables
                       Spp_Pro_I)
          
          Data_P <- rbindlist(list, #<- Merges all the data in one single file.
                              use.names = TRUE, # <- This will merge columns by Name
                              fill = TRUE, # <- This allows for the NA's
                              idcol =  NULL)  # Columns id
        }
      }
    } #if statement for species outside EEZ
  } # Species loop end
  
  #Include wich model the data is from
  Data_P$Model <- paste(Models[m])
  
  # Groups all models together in one database
  if(m == 1){
    DBEM_Results <- copy(Data_P) # <- copies the previouse data.table
  }else{
    setkey(DBEM_Results, # <- sets the data.table as "reference" ?setkey
           Species); setkey(Data_P,
                            Species);
    list <- list(DBEM_Results, # <- creates a list to merge the tables
                 Data_P)
    
    DBEM_Results <- rbindlist(list, #<- Merges all the data in one single file.
                              use.names = TRUE, # <- This will merge columns by Name
                              fill = TRUE, # <- This allows for the NA's
                              idcol =  NULL)  # Columns id
  }
  
} #End of loops



#### _____________________TEST _____________________ #
# names(DBEM_Results)
# unique(DBEM_Results$Model)
# unique(DBEM_Results$Species)
# unique(DBEM_Results$Treaty)
# length(unique(DBEM_Results$Species))
# head(DBEM_Results)

# Check that each species has 6 per INDEX or less (GFDL x2 + IPSL x2 + MPIS x2)

# DBEM_Results %>%
#   group_by(Species,INDEX) %>%
#   summarise(n()) %>%
#   View()

# DBEM_Results %>% 
#   filter(Species == "Alosa pseudoharengus",
#          INDEX == 52809)

# Checked! 

# Test that NAFO species are actually NAFO species

# DBEM_Results %>% 
#   filter(Treaty == "NAFO") %>% 
#   group_by(Species) %>% 
#   summarise(n())

# Checked!

### Check for potential repeated cells

# DBEM_Results <- Raw_DBEM_Results %>% 
#   select(INDEX,Species,Model,everything())
# 
# DBEM_Results_Clean <- DBEM_Results[!duplicated(DBEM_Results[1:3]), ]

# Checked!

### Russia distribution check ###
# In the Far East sea... 
# 
# Russia <- EEZIDs_List %>% 
#   filter(Name == "Russia (Far East)") 
# 
# Russia_EEZsID <- EEZIDs_List %>% 
#   filter(Name %in% Russia$Name) %>% 
#   left_join(EEZ_CellID,
#             by = "EEZID")
# 
# names(Russia_EEZsID)[3] <- "INDEX"
# 
# unique(Russia_EEZsID$Name)
# 
# Salmones <- c("Oncorhynchus tshawytscha",
#               "Oncorhynchus keta",
#               "Oncorhynchus kisutch",
#               "Oncorhynchus gorbuscha"
#               )
# 
# DBEM_Results %>% 
#   filter(INDEX %in% Russia_EEZsID$INDEX) %>%
#   filter(Longitude > 0 ) %>% 
#   group_by(INDEX, Longitude, Latitude) %>%
#   summarise(n =n()) %>%
#   ggplot(.,
#          aes(x = Longitude,
#              y = Latitude,
#              fill = n
#          ),
#          size = 0.05,
#          alpha = 0.5) +
#   geom_tile() + 
#   coord_map(projection = "mercator")

# Looks fine... Just like when you past it the other way... 



#### _____________________END TEST _____________________ #

### Save the dataset
# write.csv(DBEM_Results,
#           "Raw_Data.csv",
#           row.names = FALSE)
         
```

#### Estimation of Maximum Catch Potential Change

For estimating the percentage change of MCP at the regional scale, we frst aggregated the yearly mean MCP of all species per region ($X_{ry}$) and period: 

$$ X_{yr} = \sum_{s = 1}^n \hat{MCP_s}$$



where *y* is year, *r* is region, *s* is species, *n* is total number of species, and $\hat{MCP}$ is the MCP averaged by the three ESMs. In the case of North America and the GoM agrement, region is defined as the 0.5' x 0.5' grid-cell within the EEZ and the specific NAFO regulatory areas, respectiveley. For the IPHC analysis, region is defined as the comission's regulatory areas (Fig. 1). We then average the values in three time periods (*t*) to reduce temporal model sensitivity. Thus, we computed the regional percentage change in MCP ($\Delta MCP_r$) as follows:

$$\Delta MCP_r = -(1-\frac{X_{t}}{X_{t0}})*100 $$

where $X_{t}$ is the future agregated MCP for two periods, $t_1$ = mid 21^st^ century (2045-2055); and $t_3$ = end of 21^st^ century (2090-2099), and $t_0$ is the present aggregated MCP ($\mu$ 2005-2014).

<!-- #### Estimation of Changes in Catch Proportion  -->

In addition, we borrowed the concept of “threat point” from game theory (see Sumaila et al., this Volume) and estimate the change in the $\hat{MCP}$ that each country would have for each species (hereafter referred as stock-share ratio), for both the IPHC and the GoM agreement. For this, we first modify equation 1, to estimate the aggregated yearly mean MCP of each species per region. We then average the results by the same previouslly metioned periods (present, mid and end of the 21^st^ century). Next, for each species we estimated the stock-share ratio ($\alpha$) that each region had during each time period:

$$\alpha_{ts} = \frac{\theta_{rt}}{\delta_{ts}}$$

where $\theta_{r}$ is the aggregated $\hat{MCP}$ of each region, and *t* is period. Finally, we estimated the percentage change in stock-share ratio substituting $X_f$ and $X_p$ by $\alpha_{fs}$ and $\alpha_{ps}$, respectively in equation 2.

<!-- Finally, we estimated the ($\alpha$) percentage change ($\Delta\alpha$) for each region as follows: -->
<!-- $$\Delta\alpha = -(-1-\frac{\alpha_{f}}{\alpha_{p}})*100 $$ -->
<!-- where $\alpha_{f}$ is the future MCP proportion of each region (mid 21^st^ century and end of the 21^st^ century). -->



# RESULTS

```{r Load_Data, echo = F, eval = T, results='hide', warning=F,message=F}

# List of DBEM INDEX within the EEZ
#Data provided by Vicki Lam

#Data provided by Vicki Lam
EEZIDs_List <- read_excel("./Data/Spatial/Updated_EEZList_17June2016.xlsx")
EEZ_CellID <- read_excel("./Data/Spatial/EEZ_CellID.xlsx")
colnames(EEZ_CellID) <- c("EEZID","INDEX")

# DBEM Coordinate system
Coor <- fread("./Data/Spatial/Lon_Lat_DBEM.txt",header = FALSE)
colnames(Coor) <- c("INDEX","Longitude","Latitude")

# From (/Users/jpalacios/Documents/UBC/Oceans_Project/Distribution/By Cell/By_Cell_Analysis.Rmd)
Raw_DBEM_Results <- data.table::fread("./Data/Distribution/Raw_Data.csv") %>% 
  filter(Species != "Anoplopoma fimbria") #Remove

### Number of stocks per treaty##
Raw_DBEM_Results %>%
  group_by(Treaty) %>%
  summarise(x= length(unique(Species)))

#### North American EEZs ####

EEZs <- c(
  "Canada (Pacific)",
  "USA (West Coast)",
  "USA (Alaska, Arctic)",
  "USA (Alaska, Subarctic)",
  "Canada (Arctic)",
  "Canada (East Coast)",
  "USA (East Coast)"
)

All_EEZs <- EEZIDs_List %>% 
  filter(Name %in% EEZs) %>% 
  left_join(EEZ_CellID,
            by = "EEZID")

names(All_EEZs)[3] <- "INDEX"


# LAT LONG Corrections for Alaska

DBEM_Corrected <- Raw_DBEM_Results %>% 
  filter(INDEX %in% All_EEZs$INDEX) %>% 
  filter(Longitude > 0) %>% 
  mutate(Longitude = Longitude - 360)

DBEM_Corrected <- Raw_DBEM_Results %>% 
  filter(INDEX %in% All_EEZs$INDEX) %>% 
  filter(Longitude < 0) %>% 
  bind_rows(DBEM_Corrected)


#### __________________TEST NA Map _____________________ #

# DBEM_Corrected %>%
#   group_by(INDEX, Longitude, Latitude) %>%
#   summarise(n =n()) %>%
#   ggplot(.,
#          aes(x = Longitude,
#              y = Latitude,
#              fill = n
#          ),
#          size = 0.05,
#          alpha = 0.5) +
#   geom_tile() #+
# coord_map(projection = "mercator")

#### __________________All good_____________________________ #

### Get ridd of Pacific Species in the Atlantic

NAFO_E <- DBEM_Corrected %>% 
  filter(Longitude >= -100)

Pacific <- DBEM_Corrected %>% 
  filter(Treaty != "NAFO")

DBEM_Corrected <- NAFO_E %>% 
  bind_rows(Pacific)

# Species on dataset
# unique(DBEM_Corrected$Species)

# Number of species on dataset
# length(unique(DBEM_Corrected$Species))

### Get ridd of Atlantic Species in the Pacific

Pacific_Spp <- DBEM_Corrected %>% 
  filter(Longitude <= -100)

Atlantic <- DBEM_Corrected %>% 
  filter(Treaty == "NAFO")

DBEM_Corrected <- Pacific_Spp %>% 
  bind_rows(Atlantic)

###______ Double chack species distributions are correct ###

# DBEM_Corrected %>%
#   ggplot(.,
#          aes(
#            x = Longitude,
#            y = Latitude,
#            fill = log(INDEX)
#          )
#          ) +
#   geom_tile() +
#   facet_wrap(~Treaty+Species)

#### __________________All good_____________________________ #


### Final step for shapefile no need for knitting

DBEM_Coor <- DBEM_Corrected %>%
  group_by(INDEX,Longitude,Latitude) %>%
  summarise(n=n()) %>%
  select(-n,
         longitude =Longitude,
         latitude = Latitude)


## Create  shapefile for merging with analysis and IPHC shapefile

DBEM_Coor_sf = st_as_sf(DBEM_Coor,
                          coords = c("longitude", "latitude")) %>%
  st_set_crs(4326) %>% # to match shapefiles
  st_transform(4326) # to match shapefiles

#### _____________________TEST _____________________ #
# head(DBEM_Coor_sf)
# 
# ggplot(DBEM_Coor_sf) +
#   geom_sf() +
#   geom_sf(data=North_America_Land)
# 
#### _______________________________________________ #

```

### North American transboundary fisheries are shifting poleward

```{r Changes_Data_All, eval =T, echo = F, fig.height=8, fig.width=12}

# Change North America Projection for Map

North_America_Land <- North_America_Land %>% 
  st_transform(crs = 4326)

### Load shapefile the old way ###

# Path to save the plots
Path <- "./Results/Ecol/North_America"
RCP = c("GFDL26F1","IPSL26F1","MPI26F1") #Low RCP

#### New Future Method to account for mean +- sd of models #
MCP_Data <- DBEM_Corrected %>% 
  mutate(RCP = ifelse(Model %in% RCP,"Low_Emission","High_Emission")) %>% 
  group_by(INDEX,
           Model,
           RCP) %>% 
  summarise_at(vars(Beg_In:End_End), sum,na.rm=T) %>% # Sum the MCP of all species in each index by model
  # select(INDEX,Model,Beg_In:Beg_End) %>% 
  gather("Year","MCP",Beg_In:End_End) %>% 
  mutate(  # Indicate the three period times
    Period = ifelse(Year >= Beg_In & Year <= Beg_End,"Begining",
                    ifelse(Year >= Mid_In & Year <= Mid_End,"Mid_Century",
                           ifelse(Year >= End_In & Year <= End_End,"End_Century",
                                  "Other_Years"))
    )
  ) %>% 
  group_by(INDEX,Model,RCP,Period) %>% 
  summarise(Mean_T_MCP =mean(MCP,na.rm=T)) %>% #Average pero Time period
  filter(Period != "Other_Years") %>% 
  spread(Period,Mean_T_MCP) %>% #Spread to estimate MCP_Change
  mutate_at(vars(Mid_Century, # Devide future values by present
                 End_Century),
            funs(ifelse(Begining > 0, ./Begining,.)) #if no species today value is the future
  ) %>% 
  mutate_at(vars(Mid_Century, # Estimate percentage change
                 End_Century),
            funs(ifelse(Begining == 0 & . == 0, 0, # If for no change than 0
                        ifelse(Begining == 0 & . > 0, 100, # If changes from 0 to anything then 100
                               round(-(1-.)*100) # Estimate percentage change
                        )
            )
            )
  ) %>% 
  gather("Period","MCP_Change",Mid_Century,End_Century) %>% 
  mutate(Direction = ifelse(MCP_Change >= 0, "Positive","Negative")) %>% 
  group_by(INDEX,Period,RCP) %>% # Average results per ESMs
  summarise_at(vars(MCP_Change),
               funs("Mean_ESM_MCP_Chng"=mean,
                    "sd_ESM_MCP_Chng"=sd,
                    "N_ESMs"=n(),
                    "Model_Agreement" = paste(length(unique(Direction)),collapse = ";")
               )
  ) %>%
  mutate(
    Model_Agreement = ifelse(Model_Agreement == 1, "Agree","Disagree")
  ) %>% 
  left_join(DBEM_Coor,
            by="INDEX") %>% 
  mutate_at(vars(Mean_ESM_MCP_Chng,
                 sd_ESM_MCP_Chng),
            funs(ifelse(. > 100, 100,.)
            )  # set everything over 100 to 100
  )


### Explore model agreement

# ggplot(MCP_Data) +
#   geom_tile(
#     aes(
#       x = longitude,
#       y = latitude,
#       color = Model_Agreement,
#       fill = Model_Agreement
#     )
#   ) +
#   facet_grid(RCP~Period)


Seq <- seq(-100,100,by=5) #Axis

p <- ggplot(MCP_Data) +
  geom_tile(data = subset(MCP_Data, Period == "Mid_Century"),
            aes(
              x = longitude,
              y = latitude,
              color = Mean_ESM_MCP_Chng,
              fill = Mean_ESM_MCP_Chng
            )
  ) +
  geom_point(data = subset(MCP_Data, Period == "Mid_Century" & Model_Agreement == "Disagree"),
             aes(
               x = longitude,
               y = latitude
             ),
             size = 0.01,
             alpha = 0.1,
             shape = 4,
             color = "grey20"
             ) +
  geom_sf(data = North_America_Land, fill = "grey90") +
  facet_wrap(~RCP) +
  coord_sf(xlim = c(-190,-50)) +
  scale_color_gradient2(
    limits=c(-100,
             100),
    breaks = Seq) +
  scale_fill_gradient2(
    limits=c(-100,
             100),
    breaks = Seq) +
  ggtheme_map() 
  
  
  ggsave("NA_25_20_Mid.jpg",
         plot = p,
         width = 16,
         height = 10,
         units = "in",
         path = Path)
  
  ####------------- ###
  # End of century For Appendix 
  #### ------------- ###
  
  # Plot it
  ggplot(MCP_Data) +
    geom_tile(data = subset(MCP_Data, Period == "End_Century"),
              aes(
                x = longitude,
                y = latitude,
                color = Mean_ESM_MCP_Chng,
                fill = Mean_ESM_MCP_Chng
              )
    ) +
    geom_point(data = subset(MCP_Data, Period == "End_Century" & Model_Agreement == "Disagree"),
               aes(
                 x = longitude,
                 y = latitude
               ),
               size = 0.01,
               alpha = 0.1,
               shape = 4,
               color = "grey20"
    ) +
    geom_sf(data = North_America_Land, fill = "grey90") +
    facet_wrap(~RCP) +
    coord_sf(xlim = c(-190,-50)) +
    scale_color_gradient2("MCP Percentage Change",
      limits=c(-100,
               100),
      breaks = Seq) +
    scale_fill_gradient2("MCP Percentage Change",
      limits=c(-100,
               100),
      breaks = Seq) +
    ggtheme_map() +
    theme(
    legend.key = element_rect(size = 3),
    legend.key.width =unit(8,"line"),
    legend.title = element_text(size = 20),
    legend.text = element_text(size = 18)
    ) +
    # And save it
    ggsave("NA_85_26_End.jpg",
           width = 16,
           height = 10,
           units = "in",
           path = Path)
  
```

Shifts in the distribution of 33 jointly managed transboundary stocks of North America show that by 2050 maximum catch potential (MCP) of transboundary stocks will increase in Atlantic-Canadian and Alaskan waters and decrease in Pacific-Canadian and the US contiguous states (Fig. 2). Despite the overall trend, such changes will be less intense under the low emission scenario (Fig. 2-A). Under the high emission scenario, MCP will be reduced in a larger area and with greater intensity (Fig. 2-B). Such changes are expected to intensify towards the end of the 21st century, although with greater uncertainty (**Fig A1.1**).

![Fig 2. Percentage change of MCP of transboundary fisheries of North America for mid century (2046-2055) referent to 2005-2014 under a A) low emission scenario and; B) high emission scenario.](./Results/Fig2.png)


```{r Changes_Per_Species_T, eval=F, echo=F}

# This table provides the percentage change in MCP for each species, EEZ and RCP as well as the percentage change in Stock-share ratio.

# List of DBEM INDEX within the EEZ
#Data provided by Vicki Lam
EEZIDs_List <- read_excel("./Data/Spatial/Updated_EEZList_17June2016.xlsx")
EEZ_CellID <- read_excel("./Data/Spatial/EEZ_CellID.xlsx")
colnames(EEZ_CellID) <- c("EEZID","INDEX")

# DBEM Coordinate system
Coor <- fread("./Data/Spatial/Lon_Lat_DBEM.txt",header = FALSE)
colnames(Coor) <- c("INDEX","Longitude","Latitude")
#### Mid Century result Table ####
Areas <- c(
  "Canada (Arctic)",
  "Canada (East Coast)",
  "Canada (Pacific)",
  "USA (East Coast)",
  "USA (West Coast)",
  "USA (Alaska, Arctic)",
  "USA (Alaska, Subarctic)"
)

RCP <- c("GFDL26F1","IPSL26F1","MPI26F1")

Selected_Areas <- EEZIDs_List %>% 
  filter(Name %in% Areas)

#### NEW ESTIMATES 

RCP = c("GFDL26F1","IPSL26F1","MPI26F1") #Low RCP

# Common data between both

MCP_Species_Data <- DBEM_Corrected %>% 
  left_join(EEZ_CellID,
            by = "INDEX") %>% 
  filter(EEZID %in% Selected_Areas$EEZID) %>% 
  mutate(RCP = ifelse(Model %in% RCP,"Low_Emission","High_Emission"),
         Nation = ifelse(EEZID >= 958, "Alaska",
                         ifelse(EEZID == 925,"Can W",
                                ifelse(EEZID == 851, "USA E",
                                       ifelse( EEZID== 848, "USA W",
                                               "Can E"))
                         )),
         Basin = ifelse(Nation %in% c("USA E","Can E"),"Atlantic","Pacific"),
  ) %>% 
  group_by(
    Species,
    Model,
    RCP,
    Nation,
    Basin
  ) %>%
  summarise_at(vars(Beg_In:End_End), sum,na.rm=T) %>% # Sum the MCP of each species by country
  # select(INDEX,Model,Beg_In:Beg_End) %>%
  gather("Year","MCP",Beg_In:End_End) %>% 
  mutate(  # Indicate the three period times
    Period = ifelse(Year >= Beg_In & Year <= Beg_End,"Begining",
                    ifelse(Year >= Mid_In & Year <= Mid_End,"Mid_Century",
                           ifelse(Year >= End_In & Year <= End_End,"The_End_Century",
                                  "Other_Years"))
    )
  ) %>% 
  group_by(Nation,Basin,Species,Model,RCP,Period) %>% 
  summarise(Mean_T_MCP =mean(MCP,na.rm=T))

### Estimate average change of all species ####

MCP_Species_Change <- MCP_Species_Data %>% 
  filter(Period != "Other_Years") %>% 
  spread(Period,Mean_T_MCP) %>% #Spread to estimate MCP_Change
  mutate_at(vars(Mid_Century, # Devide future values by present
                 The_End_Century),
            funs(ifelse(Begining > 0, ./Begining,.)) #if no species today value is the future
  ) %>% 
  mutate_at(vars(Mid_Century, # Estimate percentage change
                 The_End_Century),
            funs(ifelse(Begining == 0 & . == 0, 0, # If for no change than 0
                        ifelse(Begining == 0 & . > 0, 100, # If changes from 0 to anything then 100
                               round(-(1-.)*100) # Estimate percentage change
                        )
            )
            )
  ) %>% 
  gather("Period","MCP_Change",Mid_Century,The_End_Century) %>% 
  mutate(Direction = ifelse(MCP_Change >= 0, "Positive","Negative")) %>% 
  group_by(Nation,Species,Period,RCP) %>% # Average results per ESMs
  summarise_at(vars(MCP_Change),
               funs("Mean_ESM_MCP_Chng"=mean,
                    "sd_ESM_MCP_Chng"=sd,
                    "N_ESMs"=n(),
                    "Model_Agreement" = paste(length(unique(Direction)),collapse = ";")
               )
  ) %>%
  mutate(
    Model_Agreement = ifelse(Model_Agreement == 1, "Agree","Disagree")
  ) %>% 
  mutate_at(vars(Mean_ESM_MCP_Chng,
                 sd_ESM_MCP_Chng),
            funs(ifelse(. > 100, 100,.)
            )  # set everything over 100 to 100
  )
  

#### Estimate Stock Share Change ####

SS_Change <- MCP_Species_Data %>% 
  group_by(RCP,Species,Period,Model) %>% 
  summarise(Total_MCP = sum(Mean_T_MCP)) %>% #Estimate todays's total (both EEZs added) MCP for each species 
  left_join(MCP_Species_Data) %>% # Inlude each nation's MCP
  mutate(Proportion = (Mean_T_MCP/Total_MCP)*100) %>%  # estimates each Country's catch proportion per period
  select(-Total_MCP,-Basin,-Mean_T_MCP) %>% 
  group_by(Nation,RCP,Species,Period) %>% #Mean of all species
  summarise(Mean_Spp_Proportion =mean(Proportion),
            sd_Spp_Proportion =sd(Proportion)
  ) %>% #Mean of all ESMs
  group_by(Nation,RCP,Period) %>% 
  summarise(Mean_ESM_Proportion = paste(round(mean(Mean_Spp_Proportion),2)," (",round(sd(Mean_Spp_Proportion),2),")",sep="")
  ) %>% 
  filter(Period %in% c("Mid_Century","The_End_Century")) %>% 
  spread(Period,Mean_ESM_Proportion)

#For paper
write.csv(SS_Change,
          "SS_Change.csv",
          row.names = F)

```


In consequence, country's share-ratio of different species would change in the direction as expected from the effects of ocean warming, regardless of the RCP scenario. Overall, shifts will be amplified under the high emission scenario relative to the low greenhouse emission scenario pathway (Table 2). While in 2050, the average shift of species will be higher for East Canada and lower for East US under the high emission scenario, the stock-share ratio of some species is expected to increase more than 50% as in the case of Atlantic menhaden (*Brevoortia tyrannus*) in Eastern Canada, and decrease by more than 50% for species such as Cusk (*Brosme brosme*) in the Eastern US under a low emission scenario. By the end of the 21^st^ century, losses will intensify with the eastern US potentially losing on average 15.2% or 46% of stock-share, depending on the scenario.

### Projected change to species managed by the IPHC

Even under a low emission scenario, most transboundary fish stocks sharing ratios will change by 2050 in the direction as expected from the effects of ocean warming. However, such changes will vary depending on the species, resulting in management consequences related to the rules placed by the different treaties. In the case of the IPHC, at least three of the 12 regulatory areas will see a reduction in MCP of Pacific halibut by 2050 in reference to current MCP of each area, regardless of the climate change scenario (Fig. 3). Poleward shifts might be constrained by the geopolitical position of countries, as well as geographic design of the coastline. It is likely that the stock shift from the US contiguous states towards Canada will offset the shift of the former towards northern regions, resulting in undetectable changes in areas 2B and 2C. Similarly, to the potential increase in MCP of regulatory areas 3B and 4ABCE along the Aleutian Islands and Bering Sea.


```{r IPHC_Map_Result_Regions, eval=T, echo=F}

### Get the INDEX in each IPHC region

Selected_Species <- c("Hippoglossus stenolepis") # Halibut

# Path for saving plots
Path <- "./Results/Ecol/IPHC/"
RCP = c("GFDL26F1","IPSL26F1","MPI26F1") #Low RCP
#### New version

#### New Future Method to account for mean +- sd of models #
IPHC_MCP_Change <- DBEM_Corrected %>% 
  filter(Species %in% Selected_Species) %>% 
  left_join(IPHC_Reg_DBEM_df,
            by = "INDEX") %>% 
  filter(!is.na(RegArea)) %>% 
  mutate(RCP = ifelse(Model %in% RCP,"Low_Emission","High_Emission")) %>% 
  gather("Year","MCP",Beg_In:End_End) %>% 
  mutate(  # Indicate the three period times
    Period = ifelse(Year >= Beg_In & Year <= Beg_End,"Begining",
                    ifelse(Year >= Mid_In & Year <= Mid_End,"Mid_Century",
                           ifelse(Year >= End_In & Year <= End_End,"End_Century",
                                  "Other_Years"))
    )
  ) %>% 
  group_by(RegArea,Model,RCP,Year,Period) %>% 
  summarise(Regional_MCP =sum(MCP,na.rm=T)) %>% # Sum of Index per Region
  group_by(RegArea,Model,RCP,Period) %>% 
  summarise(Mean_T_MCP =mean(Regional_MCP,na.rm=T)) %>% #Average pero Time period
  filter(Period != "Other_Years") %>% 
  spread(Period,Mean_T_MCP) %>% #Spread to estimate MCP_Change
  mutate_at(vars(Mid_Century, # Devide future values by present
                 End_Century),
            funs(ifelse(Begining > 0, ./Begining,.)) #if no species today value is the future
  ) %>% 
  mutate_at(vars(Mid_Century, # Estimate percentage change
                 End_Century),
            funs(ifelse(Begining == 0 & . == 0, 0, # If for no change than 0
                        ifelse(Begining == 0 & . > 0, 100, # If changes from 0 to anything then 100
                               round(-(1-.)*100) # Estimate percentage change
                        )
            )
            )
  ) %>% 
  gather("Period","MCP_Change",Mid_Century,End_Century) %>% 
  mutate(Direction = ifelse(MCP_Change >= 0, "Positive","Negative")) %>% 
  group_by(RegArea,Period,RCP) %>% # Average results per ESMs
  summarise_at(vars(MCP_Change),
               funs("Mean_ESM_MCP_Chng"=mean,
                    "sd_ESM_MCP_Chng"=sd,
                    "N_ESMs"=n(),
                    "Model_Agreement_Index" = paste(length(unique(Direction)),collapse = ";"),
                    "Model_Agreement" = paste(Direction,collapse = ";")
               )
  ) %>%
  mutate(
    Model_Agreement = ifelse(Model_Agreement == 1, "Agree","Disagree")
  ) %>% 
  mutate_at(vars(Mean_ESM_MCP_Chng,
                 sd_ESM_MCP_Chng),
            funs(ifelse(. > 100, 100,.)
            )  # set everything over 100 to 100
  )

# Ends new estimation

### Spatial Step for regional analysis ####

IPHC_DBEM_sf <- IPHC_Reg %>% 
  left_join(IPHC_MCP_Change,
            by = "RegArea") %>% 
  st_transform(3832)

# head(IPHC_DBEM_sf)

# Change name so it fits the plot
IPHC_DBEM_sf$RegArea <- gsub("Closed Area","CA",IPHC_DBEM_sf$RegArea)

# Data to plot

# IPHC_DBEM_sf_Data <- IPHC_DBEM_sf 

IPHC_DBEM_sf <- IPHC_DBEM_sf %>% 
  filter(Period == "Mid_Century")


North_America_Land <- North_America_Land %>% 
  st_transform(crs = 3832)

Seq <- seq(-30,30,by=5) #Axis

P1 <- ggplot() +
  geom_sf(data = North_America_Land, colour = "lightgrey") + # Land Map of North America
  geom_sf(data = subset(IPHC_DBEM_sf, Country == "United States"), # DBEM Of the US
          aes(fill = Mean_ESM_MCP_Chng)
  ) +
  geom_sf(data = subset(IPHC_DBEM_sf, RegArea == "2B"), # DBEM of Canada
          aes(fill = Mean_ESM_MCP_Chng)
  ) +
  geom_sf_label(data = IPHC_DBEM_sf, # RegAreas labels
                aes(
                  label = RegArea,
                  fill = Mean_ESM_MCP_Chng
                ),
                colour = "black"
  ) +
  geom_label(data=IPHC_DBEM_sf, aes(label = RCP, x =4080637 , y = 4551701, colour = RCP), #RCP labels for grid plot
             show.legend = FALSE,
             size = 10
  ) +
  facet_wrap(~RCP,  # For grid plot, comment in one plot each
             ncol = 2) +
  # scale_colour_manual(values=c("blue", "red")) + #Labels colors for grid plot
  scale_fill_gradient2("",
                       limits=c(-30,30),
                       breaks = Seq) +
  ggtheme_map() +
  theme(
    legend.key = element_rect(size = 4),
    legend.key.width =unit(8,"line"),
    legend.text = element_text(size = 16),
    strip.text.x = element_blank()
  ) +
  coord_sf(xlim = c(1963800, 10041910), # Subsets North America map
           ylim = c(3651701,9728813)
  ) +
  annotate("text", label = "Alaska", x = 6280637, y = 9228813, size = 6, colour = "black") +
  annotate("text", label = "Canada", x = 9629910, y = 9228813, size = 6, colour = "black") +
  annotate("text", label = "US Contiguous\n States", x =10000000, y = 5151701, size = 6, colour = "black", angle = -90)

# Save plot 
Name = paste("IPHC_85_26_2050.png")

ggsave(Name,
       plot = P1,
       width = 15,
       height = 10,
       units = "in",
       path = Path)



####------------- ###
  # End of century For Appendix 
#### ------------- ###


Seq <- seq(-50,50,by=10) #Axis

IPHC_DBEM_sf <- IPHC_Reg %>% 
  left_join(IPHC_MCP_Change,
            by = "RegArea") %>% 
  st_transform(3832)

IPHC_DBEM_sf$RegArea <- gsub("Closed Area","CA",IPHC_DBEM_sf$RegArea)

IPHC_DBEM_sf <- IPHC_DBEM_sf %>% 
  filter(Period == "End_Century")

# max(IPHC_DBEM_sf$Mean_ESM_MCP_Chng)

# Save plot
Name_End = paste("IPHC_85_26_2100.png")

p_end <- ggplot() +
  geom_sf(data = North_America_Land, colour = "lightgrey") + # Land Map of North America
  geom_sf(data = subset(IPHC_DBEM_sf, Country == "United States"), # DBEM Of the US
          aes(fill = Mean_ESM_MCP_Chng)
  ) +
  geom_sf(data = subset(IPHC_DBEM_sf, RegArea == "2B"), # DBEM of Canada
          aes(fill = Mean_ESM_MCP_Chng)
  ) +
  geom_sf_label(data = IPHC_DBEM_sf, # RegAreas labels
                aes(
                  label = RegArea,
                  fill = Mean_ESM_MCP_Chng
                ),
                colour = "black"
  ) +
  geom_label(data=IPHC_DBEM_sf, aes(label = RCP, x =4080637 , y = 4551701, colour = RCP), #RCP labels for grid plot
             show.legend = FALSE,
             size = 10
  ) +
  facet_wrap(~RCP,  # For grid plot, comment in one plot each
             ncol = 2) +
  scale_fill_gradient2("",
                       limits=c(-50,50),
                       breaks = Seq) +
  ggtheme_map() +
  theme(
    legend.key = element_rect(size = 4),
    legend.key.width =unit(8,"line"),
    legend.text = element_text(size = 16),
    strip.text.x = element_blank()
  ) +
  coord_sf(xlim = c(1963800, 10041910), # Subsets North America map
           ylim = c(3651701,9728813)
  ) +
  annotate("text", label = "Alaska", x = 6280637, y = 9228813, size = 6, colour = "black") +
  annotate("text", label = "Canada", x = 9629910, y = 9228813, size = 6, colour = "black") +
  annotate("text", label = "US Contiguous\n States", x =10000000, y = 5151701, size = 6, colour = "black", angle = -90)


  ggsave(Name_End,
         plot = p_end,
         width = 15,
         height = 10,
         units = "in",
         path = Path
  )

```

```{r Functions, eval = F}

getTaxInfo <- function(TaxNumber,TaxPath=NA, Sal = "NA"){
  
  # Set automatic path, change if needed
  TaxPath  <- "/Volumes/DATA/JULIANO_NEYMAR/PristineSeasData/Species/TaxonDataC0/"
  
  # Sets the tac and path 
  To_Read <- paste(TaxPath,TaxNumber,".txt",sep = "")
  
  if(Sal == "Y"){
  Spp_Info <- suppressWarnings(
    read_table2(To_Read, 
     col_names = FALSE, col_types = cols(`0` = col_character(), 
         X2 = col_number(), X3 = col_number(), 
         X4 = col_number(), X5 = col_number(), 
         X6 = col_number()), 
     skip = 16)
  ) 
  Spp_Info <- Spp_Info[1,2:6]
  }else{
  # Reads in file
  Spp_Info <- suppressMessages(
    readr::read_delim(To_Read, 
               "\t", escape_double = FALSE, col_names = FALSE, 
               # col_types = cols(X2 = col_number()),
               trim_ws = TRUE)
  )
  }
  return(Spp_Info)
}



getTTP <- function(TaxNumber,yr,TaxPath=NA){
  
  # Set automatic path, change if needed
  TaxPath  <- paste("/Volumes/DATA/JULIANO_NEYMAR/PristineSeasData/TPP",yr,"",sep="/")

  # Sets the tac and path 
  To_Read <- paste(TaxPath,"TPPotp",TaxNumber,".csv",sep = "")
  
  TPPotp <- read.csv(To_Read)
  
  return(TPPotp)
}


getEnvVar=function(yr,ModelRCP,RCP,Variable){
  
  if(ModelRCP == "IPSL"){
    ModelRCP = "IPSL-CM5A-MR"
    Filepath <- paste("/Volumes/DATA/DATA/Environmental data/Model Climate data/CMIP5/txt CMIP5/Reformatted",ModelRCP,RCP,"",sep="/")
  }
  
  
  if(ModelRCP ==  "MPI"){
    ModelRCP = "MPI-ESM-MR"
    Filepath <- paste("/Volumes/DATA/DATA/Environmental data/Model Climate data/CMIP5/txt CMIP5/Reformatted",ModelRCP,RCP,"",sep="/")
  }
  
  if(ModelRCP = "GFDL"){
    
    if(RCP == "rcp26"){
    ModelRCP <- "GFDL26"
    }else{
      ModelRCP <- "GFDL85"
    }
      
  Filepath <- paste("/Volumes/DATA/JULIANO_NEYMAR/PristineSeasData/Climate",ModelRCP,"",sep="/")
  }
  
  
  if(Variable == "Ice"){
    
    Bottom <- paste("IceExt_",yr,".txt",sep="")
    
  }
    
    if(Variable == "Temperature"){
       
      Bottom = paste("botTemp_",2005,".txt",sep="")
      
    }
    
    if(Variable == "Salinity"){
      # Bottom
      Bottom = paste("Salinity_btm_",yr,".txt",sep="")
      
    }
    
    Read_me <- paste(Filepath,Bottom,sep="")[1]
    Bottom_Data <- read.csv(Read_me,header=F)
    
   # Retrun
    
    getTemp <- Bottom_Data  
}

```

```{r 4D_exploration, eval=F, echo=F,message=F, warning=F}

# Exploring wy 4D s negative under 2.6 but positive under 8.5
# This chunk will use functions build for the Pristince seas work

### Exploration at the spatial level

Spatial_4DE <- DBEM_Corrected %>% 
  mutate(RCP = ifelse(Model %in% c("GFDL26F1","IPSL26F1","MPI26F1"),"RCP 2.6","RCP 8.5")) %>% # Set the RCPs
  filter(Species == "Hippoglossus stenolepis") %>% 
  left_join(IPHC_Reg_DBEM_df,
            by = "INDEX") %>% 
  filter(RegArea %in% c("4D","4E")) %>%
  group_by(RegArea,RCP,Model) %>% #Sum grid-cells by regulatory area, RCP and Model
  summarise_at(vars(`2005`:`2099`), sum,na.rm=T) %>% 
  tidyr::gather("Year","Total_MCP",`2005`:`2099`) %>% 
  group_by(RegArea,RCP,Year) %>% 
  summarise(
    m=mean(Total_MCP),
    sd=sd(Total_MCP)
    )

ggplot(Spatial_4DE) +
  geom_point(
    aes(
      x = Year,
      y = m,
      colour = RCP
    )
  ) +
  facet_wrap(~RegArea,
             scales = "free")

### Environmental varibales of the region

## Temp

# Variables
Model = c("GFDL","IPSL","MPIS")
RCP = c("rcp26","rcp85")

Grid <- DBEM_Corrected %>% 
  select(INDEX) %>% 
  left_join(IPHC_Reg_DBEM_df,
            by = "INDEX") %>% 
  filter(RegArea %in% c("4D","4E")) %>% 
  select(INDEX)

Variables <- c("Temperature","Salinity","Ice")

F_BData <- NULL
F_SData <- NULL
F_MData <- NULL
F_RData <- NULL
Years <- seq(2005,2100,1)

all_Grid <- seq(1,259200,1)

for(v in 3:3){
  # Loop through RCPs
  for(r in 1:2){
    # Loop through  variables
    for(m in 1:3){
      # Loop through years
      for(y in 1:length(Years)){
        
        Data <- getEnvVar(yr = Years[y],
                          Model = Model[m],
                          Variable = Variables[v],
                          RCP = RCP[r]
        ) %>% 
          mutate(INDEX = all_Grid) %>% 
          filter(INDEX %in% Grid$INDEX)
        
        if(y == 1){
          
          F_BData <- Data[1]
          
          
        }else{
          
          
          F_BData <- cbind(Data[1],F_BData)
          
        }
      }
      
      colnames(F_BData) <- Years
      
      F_BData <- F_BData %>% 
        gather(Year,Value,1:426) %>% 
        mutate(Model = Model[m],
               RCP = RCP[r],
               Variable = Variables[v])
      
      if(m == 1){
        
        F_MData <- F_BData
        
        
      }else{
        
        
        F_MData <- rbind(F_BData,F_MData)
      }
    }
    
    if(r == 1){
      
      F_RData <- F_MData
      
      
    }else{
      
      
      F_RData <- rbind(F_RData,F_MData)
    }
  }
  
  if(v == 1){
    
    F_VData <- F_RData
    
    
  }else{
    
    
    F_VData <- rbind(F_VData,F_RData)
  }
  
} # closes variable loop


write.csv(F_VData,
          "Environmental_Data_Halibut.csv",
          row.names = F)



### Exploration at the biological level

# exploited_species_list <- fread("/Volumes/DATA/PROJECTION exploited species ENM/exploited_species_list.csv")
# 600514

# Isolate Regions

DE <- IPHC_MCP_Change %>% 
  filter(RegArea %in% c("4D","4E"))

#Load Halibut Species preferences
Halibut <- getTaxInfo(600514)
# Demersal
# HabAssocSal 0 1 1 -1 -1
# HabAssocIce 0

# Temp
TTPop <- getTTP(600514,"Avg") %>% 
  filter(TempPP > 0)

Min_T <- min(TTPop$Temp)
Max_T <- max(TTPop$Temp)

# Halibut_Temp 2
# quant05 -2 
# quant25 0 
# quant50 2
# quant75 5
# quant95 11
```

```{r Figure_3, eval =F, echo =F, fig.cap="Percentage Change of MCP for Species managed by the IPHC. A, RCP 2.6 represents a low emission scenario (high mitigation). B, RCP 8.5 represents a high emission scenario (status quo)"}

img <- readPNG("/Users/jpalacios/Documents/UBC/Oceans_Project/Manuscript/Results/Fig3.png")
grid.raster(img)

```


<!-- If rendered to word use ![](), otherwise use chunk -->

![Fig 3. Percentage change of MCP for species managed by the IPHC for mid century (2046-2055) referent to 2005-2014 under a A) low emission scenario and B) high emission scenario.](./Results/Fig3.png)

The same poleward trend is expected in the change of Pacific halibut stock-share ratio with the average proportion increasing up to 25% in some northern regions and decreasing by 10% in southern regions, in relation to the present proportion (Fig. 4). Maintaining emissions to lower levels by 2050 would potentially leave unchanged the stock-share ratio of three regulatory areas (3AC, and 4D) and negatively change regulatory area 2A. On the other hand, failing to achieve such target will decrease the stock-share ratio almost half of the regulatory areas (2AC, 3AB).

```{r IPHC_Proportion_Regions, eval=F, echo = F, message=F, warning=F}

Path <- "./Results/Ecol/IPHC/"
# names(DBEM_Results)

IPHC_Species <- c("Hippoglossus stenolepis") # Halibut

#### FIlter EEZs ###

EEZs <- c(
  "Canada (Pacific)",
  "USA (West Coast)",
  "USA (Alaska, Arctic)",
  "USA (Alaska, Subarctic)"
)

RCP <- c("GFDL26F1","IPSL26F1","MPI26F1")

EEZsID <- EEZIDs_List %>% 
  filter(Name %in%EEZs) %>% 
  left_join(EEZ_CellID,
            by = "EEZID")

names(EEZsID)[3] <- "INDEX"


#### New updated method

New_IPHC_Absolutes <- DBEM_Corrected %>% 
  mutate(RCP = ifelse(Model %in% c("GFDL26F1","IPSL26F1","MPI26F1"),"Low Emission","High Emission")) %>%  # Assigns RCP by model
  filter(Species %in% IPHC_Species,
         INDEX %in% IPHC_Reg_DBEM_df$INDEX) %>%  #Selects only IPHC species within regulatory areas
  left_join(IPHC_Reg_DBEM_df,
            by = "INDEX") %>% # Include Regulatory areas
  gather("Year","MCP",`2005`:`2099`) %>% 
  group_by(RCP,RegArea,Year,Model) %>%
  summarise(MCP = sum(MCP, na.rm = T))

# Changes in the proportion in comparrison of the mean (2005-2014) proportion ####

# Estimate total MCP of each RCP per year
New_Proportion_Total <- New_IPHC_Absolutes %>% 
  group_by(RCP,Year,Model) %>% 
  summarise(Total = sum(MCP))

# Estimates the proportion of each RegArea catch pero RCP and Year
New_Proportion <- New_IPHC_Absolutes %>% 
  left_join(New_Proportion_Total,
            by = c("RCP","Year","Model")) %>% 
  mutate(Proportion = (MCP/Total)*100)

# Proportion change in the future (NOTE: not plotting by timeframe because of boxplot)
New_Proportion_Change <- New_Proportion %>% 
  mutate(Time_Step = ifelse(Year <= Beg_End, "Begining_Prop",
                            ifelse(Year >= Mid_In & Year <= Mid_End,"Mid_Century_Prop",
                                   ifelse(Year >= End_In,"The_End_Century_Prop","Others")
                            )
  ),
  Nation = ifelse(RegArea == "2A","US Contiguous",
                  ifelse(RegArea == "2B","Canada","Alaska")
  )
  ) %>% 
  group_by(RCP,
           RegArea,
           Model,
           Time_Step) %>% 
  summarise(Mean_Temp_Prop = mean(Proportion)) %>% 
  spread(Time_Step,Mean_Temp_Prop) %>% 
  mutate_at(vars(Mid_Century_Prop, # Devide future values by present
                 The_End_Century_Prop),
            funs(ifelse(Begining_Prop > 0, ./Begining_Prop,.)) #if no species today value is the future
  ) %>% 
  mutate_at(vars(Mid_Century_Prop, # Estimate percentage change
                 The_End_Century_Prop),
            funs(ifelse(Begining_Prop == 0 & . == 0, 0, # If for no change than 0
                        ifelse(Begining_Prop == 0 & . > 0, 100, # If changes from 0 to anything then 100
                               round(-(1-.)*100) # Estimate percentage change
                        )
            )
            )
  ) %>%
  gather("Time_Step","Prop_Change",Mid_Century_Prop,The_End_Century_Prop) %>% 
  group_by(RegArea,Time_Step,RCP) %>% # Average results per ESMs
  summarise_at(vars(Prop_Change),
               funs("Mean_ESM_MCP_Chng"=mean,
                    "sd_ESM_MCP_Chng"=sd,
                    "N_ESMs"=n()
               )
  ) %>% 
  mutate(Order = as.character(RegArea),
         Nation = ifelse(RegArea == "2A","US Contiguous",
                         ifelse(RegArea == "2B","Canada","Alaska")
         )
  )

New_Proportion_Change$RegArea <- gsub("2B","2B",New_Proportion_Change$RegArea) 


#### Option all in one####
ggplot(data = subset(New_Proportion_Change, Time_Step == "Mid_Century_Prop"),
       aes(
         x = reorder(RegArea,Order), # from forcasts` package
         # x = RegArea,
         y = Mean_ESM_MCP_Chng,
         fill = Nation,
         colour = Nation
       )
) +
  geom_bar(stat = "identity") +
  geom_errorbar(data = subset(New_Proportion_Change, Time_Step == "Mid_Century_Prop"),
                aes(
                  x = reorder(RegArea,Order),
                  # x = RegArea,
                  ymin=Mean_ESM_MCP_Chng-sd_ESM_MCP_Chng, # mean +- 2*sd
                  ymax=Mean_ESM_MCP_Chng+sd_ESM_MCP_Chng,
                  colour=Nation,
                ),
                width=.2,
                linetype = 2,
                size = 0.6,
                alpha = 0.5
  ) +
  coord_flip() +
  ylab("") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  ggtheme_plot() +
  scale_fill_brewer("Region",palette = "Set2") +
  scale_colour_brewer("Region",palette = "Set2") +
  scale_y_continuous(breaks = seq(-40,40,20),
                     limits = c(-40,40)
                     )+
  facet_wrap(~RCP,
             nrow = 1) +
  labs(
    x = "",
    y = "Stock Share Ratio Change (%)"
  )

 ggsave("New_Proportion_Mid.png",
       plot = last_plot(),
       width = 8,
       height =8,
       units = "in",
       path = Path
       )

```

```{r Figure_4, eval =F, echo =F, fig.cap="Percentage change of stock-share ratio for IPHC under two RCPs for Mid century (2046-2055)"}

Fig4 <- readPNG("~/Documents/UBC/Oceans_Project/Manuscript/Results/Fig4.png")
grid.raster(Fig4)

```

<!-- If rendered to word use ![](), otherwise use chunk -->

![Fig 4. Percentage change of stock-share ratio for IPHC under A) low emission scenario and B) high emission scenario for mid century (2046-2055) referent to 2005-2014.](./Results/Fig4.png)

### Projected change to species managed under the GoM agreement

While some regulatory areas of the IPHC will see increments in species' MCP, the results for the Gulf of Maine (NAFO area 5Z) show an overall decrease in MCP by 2050, depending on the climate change scenario. MCP of cod and haddock will decrease within the whole Gulf with no apparent win for any country in reference to 2014 (Fig. 5). For yellowtail flounder, some discrete areas are expected to increase with no particular pattern. Despite the overall reduction in MCP in comparison to current values, there is a benefit of achieving a low emission scenario, as reductions intensify under the high emission scenario.

```{r GB_Results_Spp, eval=F, echo = F, fig.width=12}

#### Filter Species  ####

Atlantic_Species <- c(
  "Gadus morhua",  # Cod
  "Limanda ferruginea", # Yellowtail flounder
  "Melanogrammus aeglefinus" # Haddock
)

# Run Spatial chuck for the Atlantic
# NAFO_5z$geometry

# Filter DBEM results for three specific species within the region of the GoM

N_Lim <- 45.9759
S_Lim <- 41
W_Lim <- -72.0592
E_Lim <- -63.33333 

Atlantic_DBEM <- Raw_DBEM_Results %>% 
  filter(Species %in% Atlantic_Species) %>% 
  filter( # Limit the area to George's bank
    Latitude < N_Lim, # North
    Latitude > S_Lim, # South 
    Longitude > W_Lim, # West
    Longitude < E_Lim
  )

# Path for saving plots
Path <- "./Results/Ecol/GoM/"

### MCP Change Analysis ####

#### New analysis ####
New_Mean_Data_GoM <- Atlantic_DBEM %>% 
  mutate(RCP = ifelse(Model %in% c("GFDL26F1","IPSL26F1","MPI26F1"),"Low Emission","High Emission")) %>%
  tidyr::gather("Year","Change",`2005`:`2099`) %>%
  mutate(Change = replace_na(Change, 0)) %>% # Convert NA's into 0's
  mutate(# Indicate the three period times
    Period = ifelse(Year >= Beg_In & Year <= Beg_End,"Begining",
                    ifelse(Year >= Mid_In & Year <= Mid_End,"Mid_Century",
                           ifelse(Year >= End_In & Year <= End_End,"End_Century",
                                  "Other_Years"))
    )
  ) %>% 
  filter(Period != "Other_Years") %>% # Remove unwanted years
  group_by(INDEX,Model,RCP,Period,Species) %>%
  summarise(
    Mean_Temp = mean(Change, na.rm = T) # Temporal mean
  ) %>% 
  spread(Period,Mean_Temp) %>% 
  mutate_at(vars(Mid_Century, # Devide future values by present
                 End_Century),
            funs(ifelse(Begining > 0, ./Begining,.)) #if no species today value is the future
  ) %>% 
  mutate_at(vars(Mid_Century, # Estimate percentage change
                 End_Century),
            funs(ifelse(Begining == 0 & . == 0, 0, # If for no change than 0
                        ifelse(Begining == 0 & . > 0, 100, # If changes from 0 to anything then 100
                               round(-(1-.)*100) # Estimate percentage change
                        )
            )
            )
  ) %>% 
  gather("Period","MCP_Chng",Mid_Century,End_Century) %>% 
  mutate(Direction = ifelse(MCP_Chng >= 0, "Positive","Negative")) %>% 
  group_by(INDEX,Species,Period,RCP) %>% # Average results per ESMs
  summarise_at(vars(MCP_Chng),
               funs("Mean_ESM_MCP_Chng"=mean,
                    "sd_ESM_MCP_Chng"=sd,
                    "N_ESMs"=n(),
                    "Model_Agreement" = paste(length(unique(Direction)),collapse = ";")
               )
  ) %>%
  mutate(
    Model_Agreement = ifelse(Model_Agreement == 1, "Agree","Disagree")
  ) %>% 
  mutate_at(vars(Mean_ESM_MCP_Chng,
                 sd_ESM_MCP_Chng),
            funs(ifelse(. > 100, 100,.)
            )  # set everything over 100 to 100
  ) %>% 
    left_join(GB_Coor,
            by ="INDEX")

  
  # Set Bins for better plotting
  New_Mean_Data_GoM$Bins <- cut(New_Mean_Data_GoM$Mean_ESM_MCP_Chng,breaks = 4)
  # unique(New_Mean_Data_GoM$Bins)

# _______________________________________________________

# The plot 
Seq <- seq(-100,100,10)

Lim_Neg <- min(Seq)
Lim_Max <- max(Seq)

# Use bins and collors yellow orange light red and dark red

# Mean_Data_GoMb <- Mean_Data_GoM %>% # In case you want filter a specific species
#   filter(Species == "Limanda ferruginea")


pgm <- ggplot(New_Mean_Data_GoM) +
  geom_tile(data = subset(New_Mean_Data_GoM, Period == "Mid_Century"),
            aes(
              x = Longitude,
              y = Latitude,
              color = Mean_ESM_MCP_Chng,
              fill = Mean_ESM_MCP_Chng
            )
  ) +
  geom_point(data = subset(New_Mean_Data_GoM, Period == "Mid_Century" & Model_Agreement == "Disagree"),
             aes(
               x = Longitude,
               y = Latitude
             ),
             # size = 0.1,
             alpha = 0.3,
             shape = 4,
             color = "grey20"
  ) +
  scale_fill_gradient2(paste("MCP Percentage Change \n",Mid_In,"-",Mid_End,")"), # If not using the bins
                       limits=c(Lim_Neg,
                                Lim_Max),
                       breaks = Seq,
                       na.value = 'darkred' # NA values are present when the species is no more 
  ) +
  scale_colour_gradient2(paste("MCP Percentage Change \n",Mid_In,"-",Mid_End,")"),
                         limits=c(Lim_Neg,
                                  Lim_Max),
                         breaks = Seq,
                         na.value = 'darkred' # NA values are present when the species is no more
  ) +
  geom_sf(data = GM_Land, colour = "lightgrey") +
  geom_sf(data = eez_GM, fill = NA) +
  coord_sf(xlim = c(-71.0592, -63.33333),
           ylim = c(41,45.5)
           ) +
  annotate("text", label = "United States", x = -70, y = 45, size = 4, colour = "black") +
  annotate("text", label = "Canada", x = -66.8, y = 45.4, size = 4, colour = "black") +
  annotate("text", label = "Canada", x = -65.4, y = 44.2, size = 4, colour = "black") +
  ggtheme_map() +
  theme(
    axis.line = element_line(colour = "black", size = .5),
    axis.ticks = element_line(size = .5),
    axis.text.x = element_text(size = 12,
                               angle = 0,
                               face = "plain"),
    axis.text.y = element_text(size = 12),
    legend.key = element_rect(size = 3),
    legend.key.width =unit(8,"line"),
    legend.title = element_text(size = 20),
    legend.text = element_text(size = 18)
  )  +
  facet_wrap(~RCP + Species, 
             ncol = 3
  )

  
  Name = paste("GoM_26_85_Mid.png",sep="_")

ggsave(Name,
       plot = pgm,
       width = 20,
       height = 10,
       units = "in",
       path = Path)


###-----------------###
# Plot for Appendix 
###-----------------###


pgm <- ggplot(New_Mean_Data_GoM) +
  geom_tile(data = subset(New_Mean_Data_GoM, Period == "End_Century"),
            aes(
              x = Longitude,
              y = Latitude,
              color = Mean_ESM_MCP_Chng,
              fill = Mean_ESM_MCP_Chng
            )
  ) +
  geom_point(data = subset(New_Mean_Data_GoM, Period == "End_Century" & Model_Agreement == "Disagree"),
             aes(
               x = Longitude,
               y = Latitude
             ),
             # size = 0.1,
             alpha = 0.3,
             shape = 4,
             color = "grey20"
  ) +
  scale_fill_gradient2(paste("MCP Percentage Change \n",End_In,"-",End_End,")"), # If not using the bins
                       limits=c(Lim_Neg,
                                Lim_Max),
                       breaks = Seq,
                       na.value = 'darkred' # NA values are present when the species is no more 
  ) +
  scale_colour_gradient2(paste("MCP Percentage Change \n",End_In,"-",End_End,")"),
                         limits=c(Lim_Neg,
                                  Lim_Max),
                         breaks = Seq,
                         na.value = 'darkred' # NA values are present when the species is no more
  ) +
  geom_sf(data = GM_Land, colour = "lightgrey") +
  geom_sf(data = eez_GM, fill = NA) +
  coord_sf(xlim = c(-71.0592, -63.33333),
           ylim = c(41,45.5)
           ) +
  annotate("text", label = "United States", x = -70, y = 45, size = 4, colour = "black") +
  annotate("text", label = "Canada", x = -66.8, y = 45.4, size = 4, colour = "black") +
  annotate("text", label = "Canada", x = -65.4, y = 44.2, size = 4, colour = "black") +
  ggtheme_map() +
  theme(
    axis.line = element_line(colour = "black", size = .5),
    axis.ticks = element_line(size = .5),
    axis.text.x = element_text(size = 12,
                               angle = 0,
                               face = "plain"),
    axis.text.y = element_text(size = 12),
    legend.key = element_rect(size = 3),
    legend.key.width =unit(8,"line"),
    legend.title = element_text(size = 20),
    legend.text = element_text(size = 18)
  )  +
  facet_wrap(~RCP + Species, 
             ncol = 3
  )

  
  Name = paste("GoM_26_85_End.png",sep="_")

ggsave(Name,
       plot = pgm,
       width = 20,
       height = 10,
       units = "in",
       path = Path)
  
```



![Fig 5. Percentage change of MCP in the Gulf of Main under, A) low emission scenario; and B) high emission for mid century (2041-2060) referent to present (2005-2014)](./Results/Fig5.png)

Despite the expected decrease in MCP for the region, changes in the stock-share ratio of MCP for the Gulf of Maine show different outcomes depending on the species in question. Following the high emission path will affect mostly Canada’s share of Y. flounder and in less degree Haddock, with an increase of Cod share. For the low emission scenario, patterns somehow invert with Canada losing a larger share of Haddock versus Y. flounder, while increasing Cod’s share (Fig 6).

```{r GB_Proportion_Species, eval =F, echo=F}
### Analysis by Species ####


Path <- "~/Documents/UBC/Oceans_Project/Manuscript/Results"
# names(DBEM_Results)

Atlantic_Species <- c(
  "Gadus morhua",  # Cod
  "Limanda ferruginea", # Yellowtail flounder
  "Melanogrammus aeglefinus"
)

N_Lim <- 45.9759
S_Lim <- 41
W_Lim <- -72.0592
E_Lim <- -63.33333 

# Run Spatial chuck for the Atlantic

Atlantic_DBEM <- Raw_DBEM_Results %>% 
  filter(Species %in% Atlantic_Species) %>% 
  filter( # Limit the area to George's bank
    Latitude < N_Lim, # North
    Latitude > S_Lim, # South 
    Longitude > W_Lim, # West
    Longitude < E_Lim
  )

EEZs <- c(
  "Canada (East Coast)",
  "USA (East Coast)"
)

RCP = c("GFDL26F1","IPSL26F1","MPI26F1")

EEZsID <- EEZIDs_List %>% 
  filter(Name %in%EEZs) %>% 
  left_join(EEZ_CellID,
            by = "EEZID")

names(EEZsID)[3] <- "INDEX"

GB_Coor <- Coor %>% 
  filter(INDEX %in% EEZsID$INDEX) %>% 
  # mutate(one = 1) %>% 
  filter( # Limit the area to George's bank
    Latitude < N_Lim, # North
    Latitude > S_Lim, # South 
    Longitude > -71, # West
    Longitude < E_Lim
  )

#### New updated method

New_GoM_Absolutes <- Atlantic_DBEM %>% 
  mutate(RCP = ifelse(Model %in% c("GFDL26F1","IPSL26F1","MPI26F1"),"Low Emission","High Emission")) %>%  # Assigns RCP by model
  filter(Species %in% Atlantic_Species,
         INDEX %in% GB_Coor$INDEX) %>%  #Selects only IPHC species within regulatory areas
  left_join(EEZsID,
            by = "INDEX") %>% 
  gather("Year","MCP",`2005`:`2099`) %>% 
  group_by(Species,RCP,Name,Year,Model) %>%
  summarise(MCP = sum(MCP, na.rm = T))


# Changes in the proportion in comparrison of the mean (2004-2014) proportion ####

# Estimate total MCP of each RCP per year
New_Proportion_Total <- New_GoM_Absolutes %>% 
  group_by(Species,RCP,Year,Model) %>% 
  summarise(Total = sum(MCP))


# Estimates the proportion of each RegArea catch pero RCP and Year
New_Proportion_GoM <- New_GoM_Absolutes %>% 
  left_join(New_Proportion_Total,
            by = c("RCP","Year","Model","Species")) %>% 
  mutate(Proportion = (MCP/Total)*100)

# Proportion change in the future (NOTE: not plotting by timeframe because of boxplot)
New_Proportion_Change_GoM <- New_Proportion_GoM %>% 
  mutate(Time_Step = ifelse(Year <= Beg_End, "Begining_Prop",
                            ifelse(Year >= Mid_In & Year <= Mid_End,"Mid_Century_Prop",
                                   ifelse(Year >= End_In,"The_End_Century_Prop","Others")
                            )
  )
  ) %>% 
  group_by(Species,
           RCP,
           Name,
           Model,
           Time_Step) %>% 
  summarise(Mean_Temp_Prop = mean(Proportion)) %>% 
  spread(Time_Step,Mean_Temp_Prop) %>% 
  mutate_at(vars(Mid_Century_Prop, # Devide future values by present
                 The_End_Century_Prop),
            funs(ifelse(Begining_Prop > 0, ./Begining_Prop,.)) #if no species today value is the future
  ) %>% 
  mutate_at(vars(Mid_Century_Prop, # Estimate percentage change
                 The_End_Century_Prop),
            funs(ifelse(Begining_Prop == 0 & . == 0, 0, # If for no change than 0
                        ifelse(Begining_Prop == 0 & . > 0, 100, # If changes from 0 to anything then 100
                               round(-(1-.)*100) # Estimate percentage change
                        )
            )
            )
  ) %>%
  gather("Time_Step","Prop_Change",Mid_Century_Prop,The_End_Century_Prop) %>% 
  group_by(Species,Name,Time_Step,RCP) %>% # Average results per ESMs
  summarise_at(vars(Prop_Change),
               funs("Mean_ESM_MCP_Chng"=mean,
                    "sd_ESM_MCP_Chng"=sd,
                    "N_ESMs"=n()
               )
  ) %>% 
  mutate(
    Order = ifelse(Species== "Gadus morhua", 2,
                   ifelse( Species == "Melanogrammus aeglefinus",1,3))
  )


# The plot
ggplot(data = subset(New_Proportion_Change_GoM, Time_Step == "Mid_Century_Prop"),
       aes(
         x = reorder(Species,Order),
         # x = Species
         y = Mean_ESM_MCP_Chng,
         fill = Name,
         colour = Name
       )
) +
  geom_bar(stat = "identity") +
  geom_errorbar(data = subset(New_Proportion_Change_GoM, Time_Step == "Mid_Century_Prop"),
                aes(
                  x = reorder(Species,Order),
                  # x = Species,
                  ymin=Mean_ESM_MCP_Chng-sd_ESM_MCP_Chng, # mean +- 2*sd
                  ymax=Mean_ESM_MCP_Chng+sd_ESM_MCP_Chng,
                  colour=Name,
                ),
                width=.2,
                linetype = 2,
                size = 0.6,
                alpha = 0.5
  ) +
  scale_y_continuous(breaks = seq(-15,15,5),
                     limits = c(-15,15)
                     )+
  xlab ("") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  ggtheme_plot() +
  scale_fill_brewer("Region",palette = "Set2") +
  scale_colour_brewer("Region",palette = "Set2") +
  facet_wrap(~RCP,
             nrow = 1) +
  labs(
    x = "",
    y = "Stock Share Ratio Change (%)"
  ) +
  theme(legend.position = c(0.3, 1),
        legend.direction = "horizontal",
        strip.text.x = element_blank(),
        axis.text.x = element_text(size = 12,
                               # angle = 0,
                               face = "italic",
                               # hjust = 0
                               ),
  )


 ggsave("New_GoM_Proportion_Mid.png",
       plot = last_plot(),
       width = 12,
       height = 6,
       units = "in",
       path = Path
       )

```

![Fig 6. Changes in MCP stock-share ratio for Gulf of Main under (A) low emission scenario; and (B) high emission for mid century (2041-2060) referent to 2005-2014](./Results/Fig6.png)

# DISCUSSION

<!-- ## Species shifting towards the poles  -->

The results of the present study suggest that, by 2050, climate change will alter the MCP of 33 transboundary fish stocks in North America consequently altering Canada’s and the US’s species’ stock-share ratio. For some species, such changes will intensify under the high emission carbon scenario while for others, the change will be scenario depending. These results are aligned with global [@Cheung:2010dt] and regional [@Morley:2018fn] projections suggesting that climate change will push marine species towards the poles and deeper water [@Pinsky:2013jo] in search of their ecological niche [@Poloczanska:2016kk]. Moreover, poleward shifts in Eastern Atlantic off the coast of the US have been previously recorded for American lobster (*Homarus americanus*), summer (*Paralichthys dentatus*) and yellow flounders, and red hake (*Urophycis chuss*) from North Carolina to Main [@Pinsky:2012kq]. Our models suggest that shifts will continue towards the end of the 21^st^ century resulting in changes in the proportion of the catch of important shared stocks between Canada and the US. As the effects of climate change endure, even with high mitigation, joint plans should prepare to face changes in the stock-share ratio of transboundary stocks along the coast of North America.

Geographic barriers [@Cheung:2015fm], local temperature gradients [@Pinsky:2013jo], species interactions and human activities like fishing [@Serpetti:2017he] might change the rate and direction of species shifts. Species such as haddock in the Atlantic [@Morley:2018fn], and big skate (*Raja binoculata*) in the pacific coast [@Pinsky:2013jo] have been projected to shift away from the poles. In this manner, the stock-share gain of yellow flounder and haddock by the US in the GoM (Fig. 5) and the westward increase of stock-share in IPHC regions (Fig. 4) could be a response to a temperature gradient shift, combined with geographic barriers, rather than latitudinal shifts. In recent years, Maine has seen its landings of Y. flounder increased at the expenses of southern states like New York [@Pinsky:2012kq]. Moreover, previous studies have found that under the low emission scenario, haddock is expected to stay at lower latitudes, contrary to what would happen under a high emission scenario [@Morley:2018fn]. Finally, the Gulf of Main is deeper at southern latitudes, hence, some fish are predicted to move south [@Kleisner:2016je; @Pinsky:2017hr]. These particular cases could explain the US gain in MCP in the GoM in relation to Canada as species shift their distribution from lower latitudes naturally reaching the US (lower) region first, and towards colder and deeper waters located at southern latitudes of the Gulf. At the same time, in the North West Pacific region, species can only migrate northward into the Arctic Ocean through the Bering Sea and Bering Strait [@Cheung:2015fm], potentially pushing pacific halibut west of region 3A. This westward displacement could represent a potential loss for both nations as the Gulf of Alaska is historically the most productive region of the fishery [@IPHCSecreatriat:2017uz], and potential international conflict as the stock migrates to the high seas or even reach other westerly countries’ EEZ.

The shifts in the distribution of transboundary species can jeopardize management objectives such as, conservation measures, gear operation, and quota allocations. Hypothetically, fish moving out of fishing grounds and into protected areas could result in a pressure increase to open such area to fishing. Shifting stocks could also interfere in gear-limitation management rules. Bycatch of halibut by other fisheries happen mostly on areas 3A and 4B [@NOAA:JWHvVGvq; @IPHC:2017fs]. Moreover, in past years, the Alaskan trawl fisheries have been closed before reaching annual quota due to the attainment of halibut bycatch quota limits [@Karim:2010ut]. Although not assessed in the present study, some trawling target species like Pacific cod (*Gadus macrocephalus*) are expected to move in similar direction than P. halibut [@Pinsky:2013jo]. Conflicts between fleets already exists and could be extrapolated if the situation is not foreseen [@VanDerVoo:2016uc]. The overlap of target species could be addressed by applying ecosystem-based management and dynamic management tools [@Hazen:2018fa] to manage these fisheries and reduce potential lost of sustainable harvest for both the halibut and the trawl fisheries. 

Quota allocation ruled by historic distributions will most likeley be outdated. Changes in the proportion of the quota have created tension between countries [@Spijkers:2017ij] including Canada and the US in the case of the Pacific salmon [@Miller:2013iv; @Munro:2002uf; @Song:2017va]. Poleward shifts along the coast of Oregon, Washington and British Columbia (Canada) were first addressed by the IPHC in 1985 (@McCaughran:1992uw). Changes in the distribution of the stock resulted in an adjustment in the quota allocation method, from a fixed quota allocation to a dynamic one. As climate change continues, these shifts are not expected to stop, and treaties should be flexible enough to cope with the pace and magnitude of change in order to achieve sustainable harvest under a changing climate.  

Side payments have been previously used to address changes in species distribution due to environmental forcings. In game theory, a side payment is received by a player as a compensation from the other player, with the idea that keeping cooperation is still better than playing solo [@Bjorndal:2012vd; @Sumaila:2013hv]. Side payments do not have to be in monetary form and are widely used in transboundary fisheries around the world. For example, Norway and Russia have implemented a quota swap strategy for jointly managed stocks of cod, haddock and capelin in the Barents Sea [^NR]. The adaptation of a similar agreement could help the management of fisheries in the Gulf of Main. Another example is the Nauru Agreement (PNA), responsible for managing the world's largest sustainable skipjack tuna (*Katsuwonus pelamis*) purse seine fishery [^PNA]. The PNA has a system of internationally tradable fisheries access that allows members to adapt to the effects of the El Niño Southern Oscillation [@Aqorau:2018bh]. While this is a good way to address climate variation within members of a treaty, it might fall short to address the newcomer issue, a situation that can threaten the sustainability of the stock [@Pinsky:2018cb]. A combination of the methods employed by PNA with the proper modification to incorporate new fishing nations could help mitigate future conflicts in fisheries like the Pacific halibut. Finally, It has been suggested that agreements that make cooperation the preferred strategy for all players are stronger. However, the level of government at which negotiations are held can directly impact management outcomes, as low-level agreements might lack proper penalties for non-cooperative behavior [@Miller:2013iv]. Officializing treaties like the case of the Gulf of Maine could provide better ground for the management rules and increase treaty resilience. 

[^NR]: Joint Fish, joint Russian-Norwegian Fisheries Comission available at http://www.jointfish.com/eng/THE-FISHERIES-COMMISSION/HISTORY.html
[^PNA]: The Parties to the Nauru Agreement (PNA), available at http://www.pnatuna.com/

<!-- ## Uncertanty stuff -->

In the current paper we follow a modeling approach to explore the potential impacts that climate change will have in the management of transboundary fisheries in North America. Models are attempts to represent reality (in our case a future reality) based on observational data, previously established theory, and future scenarios, and are thus, subjected to different degrees of uncertainty [@Payne:2016gn]. First, our study incorporates multiple earth system models to project the future distribution of transboundary stocks while accounting the structural uncertainty built within each ESM [@Bopp:2013fg]. In terms of the structural uncertainty build within the DBEM, previous analysis shown that the trends of changes in MCP are not affected by its structural uncertainty [@Cheung:2016jd]. Secondly, scenario planning has been widely used in climate change studies as a method to account for the uncertainty build in future decision making [@vanVuuren:2011ef]. In this aspect we considered two extreme RCPs that comprises the vast spectrum of possibilities proposed by the IPCC [@IPCC:2014bz]. A lower-than-2.6 RCP (1.5º warming) was discussed at the recent Paris Agreement sessions celebrated in Paris France. While we did not include this scenario in our analysis, previous research suggest that stronger mitigation efforts would bring large benefits to fisheries [@Cheung:2016tt]. Finally, future changes to species distributions could be influenced by interactions between species [@Pecl:2017hu], adaptation of species to environmental changes, and anthropogenic factors [@Serpetti:2017he]. However, these factors are expected to increase the rate of range-shifting of the species making our results conservative [@Cheung:2010dt; @Serpetti:2017he].


<!-- Discussion on improoving management  -->
<!-- From global (Cheung et al. 2016c) to regional (Morley et al. 2018) analysis, mitigating the effects of climate change will have positive results on fisheries (Sumaila 2019). In combination with improving management [Costello], fisheries will only be saved by a holistic approach… Indeed, dynamic management tools seem to work better than static strategies for resources expected to shift with changes in ocean condition (Pinsky and Selden 2017). -->

# CONCLUSIONS

Shifts in species distribution due to climate change have the potential of creating local extinction of economically important species while enhancing fisheries in areas where they were not present before. In this paper, we have explored the potential impacts of climate change in the joint management of 33 transboundary stocks managed by Canada and the US. We found that, transboundary species are likely to shift north in the upcoming years changing the proportion of the catch of jointly managed fisheries of Canada and the US. Lessons from other countries can provide solutions to such challenges. More specific, side payments, dynamic management, and interchangeable quotas were identified as potential solutions for North American region. While not directly addressed in this study, socio-economic impacts of shifting transboundary stocks could add an extra layer of complexity to the problem. Addressing shifts in species distribution sooner rather than latter could avert the so called "fish wars", improve sustainability of jointly managed stocks, and secure the livelihood of thousand of families that depend on stocks that move freely between national jurisdictions.

# ACKNOWLEDGEMENTS

We ack


# LITERATURE CITED

```{r Old analysis, eval = F}

#### Old North America Estimation ####

for(r in 1:2){
  
  if(r == 1){
    RCP = c("GFDL26F1","IPSL26F1","MPI26F1") #Low RCP
  }else{
    RCP = c("GFDL85F1","IPSL85F1","MPI285F1") #High RCP
  }

  # OLD VERSION _________________________________________
  # Mean for each cel from 2005-2014
  Mean_Data <- DBEM_Corrected %>% 
    filter(Model %in% RCP) %>% 
    group_by(INDEX,
             Model) %>% 
    summarise_at(vars(Beg_In:End_End), sum,na.rm=T) %>% # Sum the MCP of all species in each index by model
    select(INDEX,Beg_In:Beg_End) %>% 
    group_by(INDEX) %>% 
    summarise_at(vars(Beg_In:Beg_End), mean,na.rm=T) %>% # Yearly average of three models (Structural uncertanty)
    mutate(Mean = rowMeans(.[,2:11])) %>% # Decal average (2005-2014) of results (Uncertanty related to climate variabillity)
    select(INDEX,Mean) %>% 
    arrange(INDEX)
  
  #The future
  Future <- DBEM_Corrected %>% 
    filter(Model %in% RCP) %>% 
    group_by(INDEX,
             Model) %>% 
    summarise_at(vars(Beg_In:End_End), sum,na.rm=T) %>% # Sum the MCP of all species in each index by model
    group_by(INDEX) %>% 
    summarise_at(vars(`2015`:End_End), mean,na.rm=T) %>% # Yearly average of three models
    arrange(INDEX)
  
  #SD future
  # for this we have to first average the temporal variabillity for each model and then average the models, that way we will have the SD resulted of the model average and not the termporal variation
  
  SD_Future <- DBEM_Corrected %>%
    # filter( INDEX == 67071) %>%
    filter(Model %in% RCP) %>%
    group_by(INDEX,
             Model) %>%
    summarise_at(vars(`2005`:`2099`), sum,na.rm=T) %>% # Sum the MCP of all species in each index by model
    tidyr::gather("Year","Change",3:97) %>%
    filter(Year >= 2045 & Year <= 2054) %>% # Select mid century
    group_by(INDEX,Model) %>%
    summarise(
      Mean_Temp = mean(Change, na.rm = T), # Temporal Mean and SD 
      SD_Temp = sd(Change, na.rm = T)
    ) %>%
    group_by(INDEX) %>%
    summarise(
      Mean_M = mean(Mean_Temp, na.rm = T), # Model mean
      SD_M = sd(Mean_Temp, na.rm = T) # Model SD
    ) %>%
    filter(!is.na(SD_M)) %>%
    mutate(SD_Plus = ifelse((SD_M*2) > Mean_M,"No agreement","Agree")) %>% # If 2xSD is bigger than the mean, then models don't agree, otherwise they do
    # filter(SD_Plus > 0) %>%
    left_join(DBEM_Coor,
              by="INDEX")
  
  #### Overall agreement. Number of cells where models don't match
  
  # SD_Future %>%
  #   group_by(SD_Plus) %>%
  #   summarise(n())
  
  # RCp 2.6 30% of grids don't agree
  # Agree 3825
  # Don't agree 1140
  
  # RCp 8.5 32% of grids don't agree
  # Agree         3564
  # No agreement  1151
  
  # #Devide one by the other
  
  #### _______________________________________________ #
  
  # Devide future projections by "today's"" projections
  
  Cell_Index <- sweep(Future[2:86],#Future catch p.
                      1, #1 goes by row and 2 goes by colum
                      Mean_Data$Mean, #the means
                      "/") %>% 
    mutate(INDEX = Future$INDEX) %>% 
    select(INDEX,everything())
  
  
  Mid_Century <- Cell_Index %>% 
    select(INDEX,
           Mid_In:Mid_End) %>% 
    mutate(Mean = rowMeans(.[,2:11])) %>% # Temporal average
    # left_join(NorthA_Coor_df,
              # by ="INDEX") %>% 
    mutate(Percentage = round(-(1-Mean)*100)) %>% # Convert to percentage change
    mutate("Percentage Change" = ifelse(Percentage > 100, 100,Percentage)) %>%  # set everything over 100 to 100
    filter(!is.na(`Percentage Change`)) %>% 
    left_join(DBEM_Coor,
              by="INDEX") 
  
    #### North America Transboundary Plot ####
  
  Seq <- seq(-100,100,by=20) #Axis

  ggplot() +
    geom_tile(data = Mid_Century, # Percentage change data
              aes(
                x = longitude,
                y = latitude,
                colour = `Percentage Change`,
                fill = `Percentage Change`
              )
    ) +
    geom_point(data = subset(SD_Future, SD_Plus == "No agreement"), # ESM model uncertanty
               aes(
                 x = longitude,
                 y = latitude
               ),
               size = 0.05,
               alpha = 0.5,
               shape = 6,
               colour = "grey20") +
    geom_sf(data = North_America_Land, fill = "grey90") + # Base map
    coord_sf(xlim = c(-190,-50)) +
    scale_colour_gradient2(
      limits=c(-100,
               100),
      breaks = Seq) +
    scale_fill_gradient2(
      limits=c(-100,
               100),
      breaks = Seq) +
    ggtheme_map() 
  
   if(r == 1){
    Name = paste("North_America_Change_26_2050.png")
  }else{
    Name = paste("North_America_Change_85_2050.png")
  }
  
  ggsave(Name,
         plot = last_plot(),
         width = 12,
         height = 10,
         units = "in",
         path = Path)
  
  
  ### now we average the results from the models for END century ###
  
  End_Century <- Cell_Index %>% 
    select(INDEX,
           `2090`:`2099`) %>% 
    mutate(Mean = rowMeans(.[,2:11])) %>% 
    mutate(Percentage = round(-(1-Mean)*100)) %>% # Convert to percentage
    mutate("Percentage Change" = ifelse(Percentage > 100, 100,Percentage)) %>%  # set everything over 100 to 100
    filter(!is.na(`Percentage Change`)) %>% 
    left_join(DBEM_Coor,
              by="INDEX")
  
  SD_End <- DBEM_Corrected %>% 
    # filter( INDEX == 67071) %>% 
    filter(Model %in% RCP) %>% 
    group_by(INDEX,
             Model) %>% 
    summarise_at(vars(`2005`:`2099`), sum,na.rm=T) %>% 
    tidyr::gather("Year","Change",3:97) %>% 
    filter(Year >= 2090 & Year <= 2099) %>% 
    group_by(INDEX,Model) %>% 
    summarise(
      Mean_Temp = mean(Change, na.rm = T), # Mean temporal
      SD_Temp = sd(Change, na.rm = T) #Sd of 10 years average
    ) %>% 
    group_by(INDEX) %>% 
    summarise(
      Mean_M = mean(Mean_Temp, na.rm = T), # Models mean
      SD_M = sd(Mean_Temp, na.rm = T) #Models Sd
    ) %>% 
    filter(!is.na(SD_M)) %>% 
    mutate(SD_Plus = ifelse((SD_M*2) > Mean_M,"No agreement","Agree")) %>% 
    # filter(SD_Plus > 0) %>% 
    left_join(DBEM_Coor,
              by="INDEX")
  
  ggplot() +
    geom_tile(data = End_Century,
              aes(
                x = longitude,
                y = latitude,
                colour = `Percentage Change`,
                fill = `Percentage Change`
              )
    ) +
    geom_point(data = subset(SD_End, SD_Plus == "No agreement"),
               aes(
                 x = longitude,
                 y = latitude
               ),
               size = 0.05,
               alpha = 0.5,
               shape = 6,
               colour = "grey20") +
    geom_sf(data = North_America_Land, fill = "grey90") +
    coord_sf(xlim = c(-190,-50)) +
    scale_colour_gradient2(
      limits=c(-100,
               100),
      breaks = Seq) +
    scale_fill_gradient2(
      limits=c(-100,
               100),
      breaks = Seq) +
    ggtheme_map() 
  
  if(r == 1){
    Name_End = paste("North_America_Change_26_2100.png")
  }else{
    Name_End = paste("North_America_Change_85_2100.png")
  }
  
  ggsave(Name_End,
         plot = last_plot(),
         width = 12,
         height = 10,
         units = "in",
         path = Path)

}

#### Old IPHC estimation ####

# Future change in MCP of IPHC per region
IPHC_MCP_Change <- DBEM_Corrected %>% 
  mutate(RCP = ifelse(Model %in% c("GFDL26F1","IPSL26F1","MPI26F1"),"RCP 2.6","RCP 8.5")) %>% # Set the RCPs
  filter(Species %in% Selected_Species#,
         # INDEX %in% IPHC_Reg_DBEM_df$INDEX
         ) %>% # Filter species to halibut and the region for the IPHC regulatory area
  # group_by(INDEX,Model,RCP,Species) %>% # Add values per species
  # summarise_at(vars(`2005`:`2099`), sum,na.rm=T) %>%
  left_join(IPHC_Reg_DBEM_df,
            by = "INDEX") %>% # Include the regulatory areas info
  group_by(RegArea,RCP,Model) %>% #Sum grid-cells by regulatory area, RCP and Model
  summarise_at(vars(`2005`:`2099`), sum,na.rm=T) %>% 
  tidyr::gather("Year","Change",`2005`:`2099`) %>%
  mutate(# Indicate the three period times
    Period = ifelse(Year >= 2005 & Year <= 2014,"Today",
                    ifelse(Year >= 2046 & Year <= 2055,"Mid Century",
                           ifelse(Year >= 2090 & Year <= 2099,"End Century",
                                  "Other_Years"))
    )
  ) %>% 
  filter(Period != "Other_Years") %>% # Remove unwanted years
  group_by(RegArea,Model,RCP,Period) %>%
  summarise(
    Mean_Temp = mean(Change, na.rm = T), # Temporal mean
    SD_Temp = sd(Change, na.rm = T) #Temporal sd
  ) %>% 
  group_by(RegArea,RCP,Period) %>% # Models (GFDL,IPSL,MPIs) mean and SD
  summarise(
    Mean_M = mean(Mean_Temp, na.rm = T),
    SD_M = sd(Mean_Temp, na.rm = T)
  ) %>% 
  filter(!is.na(SD_M)) %>% 
  mutate(Robust = ifelse((SD_M*2) > Mean_M,"No agreement","Agree"))  %>% # Flags robustness in data
  # filter(Robust > 0) %>%
  select(RegArea,RCP,Period,Mean_M) %>% # They all agree except for 4D mid century
  spread(Period,Mean_M) %>% 
  mutate( # Estimate the percentage change
    Change_Mid = `Mid Century`/Today,
    Change_End = `End Century`/Today,
    Percentage_Mid = round(-(1-Change_Mid)*100),
    Percentage_End = round(-(1-Change_End)*100)
  ) %>% 
  select(RegArea, RCP, Percentage_Mid,Percentage_End)


#### Species Table for SS proportion change ####

#### OLD VERSION 

# Average (GFDL, MPI, IPSL) MCP of each species from 2005-2099 for both RCP's
Overall <- DBEM_Corrected %>%
  left_join(EEZ_CellID,
            by = "INDEX") %>% 
  # head() %>%
  filter(EEZID %in% Selected_Areas$EEZID) %>% 
  mutate( # determine what nation is wach region, what result is fr each RCP and Basin
    Nation = ifelse(EEZID >= 958, "Alaska",
                    ifelse(EEZID == 925,"Can W",
                           ifelse(EEZID == 851, "USA E",
                                  ifelse( EEZID== 848, "USA W",
                                          "Can E"))
                    )),
    RCP = ifelse(Model %in% RCP,"Low_Emission","High_Emission"), # determine which model is ehat RCP
    Basin = ifelse(Nation %in% c("USA E","Can E"),"Atlantic","Pacific"),
  ) %>% 
  group_by(Species,Nation,Basin,RCP,Model) %>% # Adds each species' MCP of all INDEX-cells within each "nation" EEZ
  summarise_if(is.numeric,sum,na.rm=T) %>% # sum of values 
  group_by(Species,Nation,Basin,RCP) %>%  
  summarise_at(vars(`2005`:`2099`),mean,na.rm=T) %>% # Average the MCP results from the three ESMs
  gather("Year","MCP",`2005`:`2099`) %>% 
  mutate(  # Indicate the three period times
    Period = ifelse(Year >= 2004 & Year <= 2014,"Today",
                    ifelse(Year >= 2046 & Year <= 2055,"Mid_Century",
                           ifelse(Year >= 2090 & Year <= 2099,"End_Century",
                                  "Other_Years"))
    )
  ) %>% # Set the three time periods 
  filter(Period != "Other_Years") %>% # Remove whatever is in the middle
  group_by(Species,Nation,Basin,RCP,Period) %>% 
  summarise(Period_MCP = mean(MCP)) #Temporal average of results

#### Percentage Change in MCP for each species period, and RCP ####

MCP_Spp_Change <- Overall %>%
  spread(Period,Period_MCP) %>% 
  mutate( # Devides the different timeframes by the present and estimates percentage change
    Change_End = `End_Century`/Today,
    Change_Mid = `Mid_Century`/Today,
    Mid_Century = -(1-Change_Mid)*100,
    The_End_Century = -(1-Change_End)*100
  ) %>%
  gather("Period","Percentage_Change",Mid_Century:The_End_Century) %>% 
  ungroup() %>% 
  select(-5)
  
# group_by(Nation,Period,RCP) %>% # Average the results per species
#   summarise(
#     Mean_All = mean(Percentage_Change, na.rm = T),
#     sd_All = sd(Percentage_Change, na.rm = T)
#   ) %>%
#   View() # Average proportion change of all species


  #### Compare versions
  
  # Comparring <- MCP_Species_Data %>% 
  #   select(1:5) %>% 
  #   left_join(MCP_Spp_Change) %>% 
  #   mutate(Diff = Mean_ESM_MCP_Chng - Percentage_Change)
  # 
  # 
  # 

#### Percentage Change in stock-share ratio for each species period, and RCP ####

SS_Change <- Overall %>%
  group_by(RCP,Basin,Species,Period) %>% 
  summarise(Total_MCP = sum(Period_MCP)) %>% #Estimate todays's total (both EEZs added) MCP for each species (for each Basin!)
  left_join(Overall) %>% # Inlude each nation's MCP
  mutate(
    Proportion = (Period_MCP/Total_MCP)*100 # estimates each Country's catch proportion per period
  ) %>% 
  select(Species,Nation,Basin,RCP,Period,Proportion) %>% 
  spread(Period,Proportion) %>% # Spread for easier mutation
  mutate( # Estimate the percentage change
    SSR_Change_Mid = `Mid Century`/Today,
    SSR_Change_End = `End Century`/Today,
    SSR_Percentage_Mid = round(-(1-SSR_Change_Mid)*100),
    SSR_Percentage_End = round(-(1-SSR_Change_End)*100)
  ) %>% 
  # View() # Average change in MCP proportion per Nation (comment it to have a mean +-sd of all areas)
  group_by(RCP,Nation) %>% 
    summarise(mean = mean(SSR_Percentage_End),
              sd = sd(SSR_Percentage_End)
              )

#### IPHC proportion change

#### Old version

IPHC_Absolutes <- DBEM_Corrected %>% 
  mutate(RCP = ifelse(Model %in% c("GFDL26F1","IPSL26F1","MPI26F1"),"RCP 2.6","RCP 8.5")) %>%  # Assigns RCP by model
  filter(Species %in% IPHC_Species,
         INDEX %in% IPHC_Reg_DBEM_df$INDEX) %>%  #Selects only IPHC species within regulatory areas
  left_join(IPHC_Reg_DBEM_df,
            by = "INDEX") %>% # Include Regulatory areas
  gather("Year","MCP",`2005`:`2099`) %>% 
  group_by(RCP,RegArea,Year,Model) %>%
  summarise(Total_MCP = sum(MCP, na.rm = T)) %>% # Sums INDEX MCP per RegArea
  group_by(RCP,RegArea,Year) %>% 
  summarise(Mean_MCP = mean(Total_MCP, na.rm = T), #Yearly mean per ESM model
            SD_MCP = sd(Total_MCP, na.rm = )
  ) %>% 
  mutate(Year = as.numeric(Year))

# Changes in the proportion in comparrison of the mean (2004-2014) proportion ####

# Estimate total MCP of each RCP per year
Proportion_Total <- IPHC_Absolutes %>% 
  group_by(RCP,Year) %>% 
  summarise(
    Total = sum(Mean_MCP),
    Total_SD = sum(SD_MCP)
  )

# head(Proportion_Total)

# Estimates the proportion of each RegArea catch pero RCP and Year
Proportion_Change <- IPHC_Absolutes %>% 
  left_join(Proportion_Total,
            by = c("RCP","Year")) %>% 
  mutate(Proportion = (Mean_MCP/Total)*100)

# Todays proportion
Early_Proportion <- Proportion_Change %>% 
  filter(Year <= Beg_End) %>% 
  group_by(RCP,
           RegArea) %>% 
  summarise(Mean_Prop = mean(Proportion))

# Proportion change in the future (NOTE: not plotting by timeframe because of boxplot)
Proportion_Change <- IPHC_Absolutes %>% 
  left_join(Proportion_Total,
            by = c("RCP","Year")) %>% # Join with total MCP
  mutate(Proportion = (Mean_MCP/Total)*100) %>% # Get proportions
  left_join(Early_Proportion,
            by= c("RCP","RegArea")) %>% # Include baseline proportion
  mutate(Change = Proportion/Mean_Prop) %>%  # devide future changes by baseline
  mutate(Percentage = round(-(1-Change)*100,2),
         Year = as.numeric(Year)) %>% 
  arrange(RCP) %>% 
   mutate(Time_Step = ifelse(Year >= Mid_In & Year <= Mid_End,"Mid Century",
                            ifelse(Year >= End_In,"End Century","NA")),
          Nation = ifelse(RegArea == "2A","US Contiguous",
                          ifelse(RegArea == "2B","Canada","Alaska")
                          )
          ) %>% 
  filter(Time_Step != "NA",
         RegArea != "NA",
         Time_Step == "End Century")

Proportion_Change$RegArea <- gsub("2B","2B",Proportion_Change$RegArea)


#### Option all in one####
PL <- ggplot(subset(Proportion_Change, RCP == "RCP 2.6"),
         aes(
           x = reorder(RegArea,Percentage, FUN = median), # from forcasts` package
           # x = Nation, # from forcasts` package
             y = Percentage,
             # fill = Nation,
           colour = Nation
         )
  ) +
  geom_boxplot() +
  ylab("") +
  xlab ("") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  ggtheme_plot() +
  # scale_fill_brewer("Region",palette = "Set2") +
  scale_colour_brewer("Region",palette = "Set2") +
  theme(legend.position = c(0.2, 0.98),
        legend.direction = "horizontal") #+ 
  # geom_label(data=Proportion_Change, aes(label = "RCP 2.6", x = "2A" , y = 18, fill = NA), #RCP labels for grid plot
  #            colour = "blue",
  #            show.legend = FALSE,
  #            size = 5
  # )

  

PH <- ggplot(subset(Proportion_Change, RCP == "RCP 8.5"),
         aes(
           x = reorder(RegArea,Percentage, FUN = median), # from forcasts` package
           # x = Nation, # from forcasts` package
             y = Percentage,
             # fill = Nation,
           colour = Nation
         )
  ) +
  geom_boxplot() +
  ggtheme_plot() +
  ylab("") +
  xlab ("IPHC Regulatory Area") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  ggtheme_plot() +
  # scale_fill_brewer("Region",palette = "Set2",guide=FALSE) + 
  scale_colour_brewer("Region",palette = "Set2",guide=FALSE) #+
  # geom_label(data=Proportion_Change, aes(label = "RCP 8.5", x = "3B" , y = 18, fill = NA), #RCP labels for grid plot
  #            colour = "red",
  #            show.legend = FALSE,
  #            size = 5
  # )

ggdraw() +
  draw_plot(PL, x = 0, y = 0.5, width = 1, height = 0.5) +
  draw_plot(PH, x = 0, y = 0, width = 1, height = 0.5) +
  draw_plot_label(label = c("A", "B"), size = 15,
                  x = c(0, 0), 
                  y = c(1, 0.5)) +
  draw_plot_label(label = "Stock-Share Percentage Change", size = 12, angle = 90, fontface = "plain",
                  x = 0.02,
                  y =0.11999)

### OLD VERION GOM 

#### Old analysis ##3
Mean_Data_GoM <- Atlantic_DBEM %>% 
  mutate(RCP = ifelse(Model %in% c("GFDL26F1","IPSL26F1","MPI26F1"),"RCP 2.6","RCP 8.5")) %>%
  tidyr::gather("Year","Change",`2005`:`2099`) %>%
  mutate(# Indicate the three period times
    Period = ifelse(Year >= 2005 & Year <= 2014,"Today",
                    ifelse(Year >= 2046 & Year <= 2055,"Mid Century",
                           ifelse(Year >= 2090 & Year <= 2099,"End Century",
                                  "Other_Years"))
    )
  ) %>% 
  filter(Period != "Other_Years") %>% # Remove unwanted years
  group_by(INDEX,Model,RCP,Period,Species) %>%
  summarise(
    Mean_Temp = mean(Change, na.rm = T), # Temporal mean
    SD_Temp = sd(Change, na.rm = T) #Temporal sd
  ) %>% 
  group_by(INDEX,RCP,Period,Species) %>% # Models (GFDL,IPSL,MPIs) mean and SD
  summarise(
    Mean_M = mean(Mean_Temp, na.rm = T),
    SD_M = sd(Mean_Temp, na.rm = T)
  ) %>% 
  filter(!is.na(SD_M)) %>% 
  mutate(Robust = ifelse((SD_M*2) > Mean_M,"No agreement","Agree"))  %>% # Flags robustness in data
  filter(Robust > 0) %>%
  select(INDEX,Species,RCP,Period,Mean_M) %>% # They all agree except for 4D mid century
  spread(Period,Mean_M) %>% 
  mutate( # Estimate the percentage change
    Change_Mid = `Mid Century`/Today,
    Change_End = `End Century`/Today,
    Percentage_Mid = ifelse(round(-(1-Change_Mid)*100) > 100, 100,round(-(1-Change_Mid)*100)),
    Percentage_End = ifelse(round(-(1-Change_End)*100) > 100, 100,round(-(1-Change_End)*100))
    ) %>% 
  select(INDEX, Species, RCP, Percentage_Mid,Percentage_End) %>% 
    left_join(GB_Coor,
            by ="INDEX")



#   mutate("Percentage Change" = ifelse(Percentage > 100, 100,Percentage)) %>%  # set everything over 100 to 
#   filter(!is.na(Longitude)) %>% 
#   filter(Latitude <= 50)

Mean_Data_GoM$Bins <- cut(Mean_Data_GoM$Mid_Century,breaks = 4)
# unique(Mid_Century$Bins)

# _______________________________________________________

# The plot 
Seq <- seq(-100,100,10)

Lim_Neg <- min(Seq)
Lim_Max <- max(Seq)

# Use bins and collors yellow orange light red and dark red

# Mean_Data_GoMb <- Mean_Data_GoM %>% # In case you want filter a specific species
#   filter(Species == "Limanda ferruginea")

ggplot() +
  geom_tile(data = Mean_Data_GoM,
            aes(
              x = Longitude,
              y = Latitude,
              fill = Percentage_Mid,
              colour = Percentage_Mid
              # fill = reorder(Bins,-Percentage),
              # colour = reorder(Bins,-Percentage)
            )
  ) +
  # scale_color_manual("MCP % Change",values=c("darkblue","lightblue","red","darkred")) + # for Bins option A
  # scale_fill_manual("MCP % Change",values=c("darkblue","lightblue","red","darkred")) + # for Bins option A
  # scale_color_brewer("MCP % Change",type='seq', palette='Reds') + # for Bins option B
  # scale_fill_brewer("MCP % Change",type='seq', palette='Reds') + # for Bins option B
  scale_fill_gradient2("MCP Percentage Change \n(2046-2055)", # If not using the bins
                       limits=c(Lim_Neg,
                                Lim_Max),
                       breaks = Seq,
                       na.value = 'darkred' # NA values are present when the species is no more 
  ) +
  scale_colour_gradient2("MCP Percentage Change \n(2046-2055)",
                         limits=c(Lim_Neg,
                                  Lim_Max),
                         breaks = Seq,
                         na.value = 'darkred' # NA values are present when the species is no more
  ) +
  # geom_label(data = Mean_Data_GoMb,
  #            aes(
  #              x = Longitude,
  #              y = Latitude,
  #              label = INDEX
  #            )
  # ) +
  geom_sf(data = GM_Land, colour = "lightgrey") +
  geom_sf(data = eez_GM, fill = NA) +
  annotate("text", label = "United States", x = -70, y = 45, size = 4, colour = "black") +
  annotate("text", label = "Canada", x = -66.8, y = 45.4, size = 4, colour = "black") +
  annotate("text", label = "Canada", x = -65.4, y = 44.2, size = 4, colour = "black") +
  coord_sf(xlim = c(-71.0592, -63.33333),
           ylim = c(41,45.5)
  ) +
  ggtheme_map() +
  theme(
    axis.line = element_line(colour = "black", size = .5),
    axis.ticks = element_line(size = .5),
    axis.text.x = element_text(size = 12,
                               angle = 0,
                               face = "plain"),
    axis.text.y = element_text(size = 12),
    legend.key = element_rect(size = 3),
    legend.key.width =unit(8,"line"),
    legend.title = element_text(size = 20),
    legend.text = element_text(size = 18)
  ) +
  facet_wrap(~RCP + Species, 
             ncol = 3
  )

Name = paste("Change_GB_26_85_2050.png",sep="_")

ggsave(Name,
       plot = last_plot(),
       width = 20,
       height = 10,
       units = "in",
       path = Path)



```

```{r IPHC_Proportion_EEZ, eval=F, echo = F, message=F, warning=F}

Path <- "/Users/jpalacios/Documents/UBC/Oceans_Project/Manuscript/Results"
# names(DBEM_Results)

IPHC_Species <- c(
  "Anoplopoma fimbria",  # Sablefish
  "Hippoglossus stenolepis" # Halibut
)

#### FIlter EEZs ###

EEZs <- c(
  "Canada (Pacific)",
  "USA (West Coast)",
  # "USA (Alaska, Arctic)",
  "USA (Alaska, Subarctic)"
)

RCP <- c("GFDL26F1","IPSL26F1","MPI26F1")

EEZsID <- EEZIDs_List %>% 
  filter(Name %in%EEZs) %>% 
  left_join(EEZ_CellID,
            by = "EEZID")

names(EEZsID)[3] <- "INDEX"
# 
# head(EEZsID)
# head(EEZIDs_List)
# unique(EEZsID$Name)

IPHC_Absolutes <- DBEM_Results %>% 
  filter(Species %in% IPHC_Species) %>%  #Selects only IPHC species
  filter(INDEX %in% EEZsID$INDEX) %>% # Inside EEZ
  left_join(EEZsID,
            by = "INDEX",
            all = FALSE) %>%
  # filter(!duplicated(.)) %>% 
  gather("Year","MCP",2:96) %>%  # Removes duplicated
  mutate(RCP = ifelse(Model %in% RCP, "RCP 2.6","RCP 8.5"),
         Nation = ifelse(grepl('Alaska',Name),"Alaska",Name)) %>% 
  group_by(Model,RCP,Nation,Year) %>%
  summarise(Total_MCP = sum(MCP, na.rm = T)) %>% # Sums MCP per EEZ
  group_by(RCP,Nation,Year) %>% 
  summarise(Mean_MCP = mean(Total_MCP, na.rm = T), #Mean per ESM model
            SD_MCP = sd(Total_MCP, na.rm = )
  ) %>% 
  mutate(Year = as.numeric(Year))


# Changes in the proportion in comparrison of the mean (2004-2014) proportion ####

Proportion_Total <- IPHC_Absolutes %>% 
  group_by(RCP,Year) %>% 
  summarise(
    Total = sum(Mean_MCP),
    Total_SD = sum(SD_MCP)
  )

# head(Proportion_Total)

Proportion_Change <- IPHC_Absolutes %>% 
  left_join(Proportion_Total,
            by = c("RCP","Year")) %>% 
  mutate(Proportion = (Mean_MCP/Total)*100)

Early_Proportion <- Proportion_Change %>% 
  filter(Year <= 2014) %>% 
  group_by(RCP,
           Nation) %>% 
  summarise(Mean_Prop = mean(Proportion))

Proportion_Change <- IPHC_Absolutes %>% 
  left_join(Proportion_Total,
            by = c("RCP","Year")) %>% 
  mutate(Proportion = (Mean_MCP/Total)*100) %>% 
  left_join(Early_Proportion,
            by= c("RCP",
                  "Nation")) %>% 
  mutate(Change = Proportion/Mean_Prop) %>% 
  mutate(Percentage = round(-(1-Change)*100,2)) %>% 
  arrange(RCP)

#### The actual plot ####

ggplot(Proportion_Change) +
  aes(x = Year,
      y = Percentage,
      color = Nation) +
  geom_line() +
  # geom_smooth(method = "lm", se = TRUE) +
  ylim(-15,10)+
  ylab("Percentage Change")+
  facet_wrap(~RCP,
             nrow = 1
             # scales = "free_y"
  ) +
  scale_colour_manual(
    values = c("purple","red","blue"),
    labels = c("Alaska", "Canada", "US")
  )+
  geom_hline(yintercept = 0) +
  theme_classic()+
  theme(plot.title=element_blank(), #clears title
        panel.background=element_blank(), #clears background 
        axis.text.x=element_text(size=20), # Size of axis labels
        axis.text.y =element_text(size=20), # Size of axis labels
        axis.title=element_text(size=20), # Size of axis title
        axis.title.x = element_text(vjust = .5), # Alignment of axis title
        # axis.ticks = element_blank(), # Removes axis ticks
        # axis.line = element_blank(), # Removes axis line,
        legend.position = "top", # bottom, top, right, left
        # legend.key = element_rect(size = 15), # Legend box size
        # legend.key.height =unit(1,"line"),
        # legend.key.width =unit(1,"line"),
        legend.background = element_rect(),
        legend.text = element_text(size = 18), #Legend text size
        legend.title = element_blank(), # Legend title size
        strip.background = element_blank(), #Facewrap options
        strip.text = element_text(size = 20)
  ) 

# Save figure

# ggsave("Fig3.png",
#        plot = last_plot(),
#        width = 12,
#        height = 6,
#        units = "in",
#        path = Path)


### Box plot ###

Proportion_Change %>% 
  mutate(Time_Step = ifelse(Year >= 2046 & Year <= 2055,"Mid Century",
                            ifelse(Year >= 2089,"End Century","NA"))) %>% 
  filter(Time_Step != "NA") %>% 
  ggplot(.,
         aes(x = fct_rev(Time_Step), # from forcasts` package
             y = Percentage,
             fill = Nation
         )
  ) +
  geom_boxplot() +
  ylab("Percentage Change") +
  xlab ("Time Step") +
  facet_wrap(~RCP,
             nrow = 1#,
             # scales = "free_y"
  ) +
  scale_fill_manual(
    values = c("purple","red","blue"),
    labels = c("Alaska", "Canada", "US")
  )+
  geom_hline(yintercept = 0) +
  theme_classic() +
  theme(plot.title=element_blank(), #clears title
        panel.background=element_blank(), #clears background 
        axis.text.x=element_text(size=20), # Size of axis labels
        axis.text.y =element_text(size=20), # Size of axis labels
        axis.title=element_text(size=20), # Size of axis title
        axis.title.x = element_text(vjust = .5), # Alignment of axis title
        # axis.ticks = element_blank(), # Removes axis ticks
        # axis.line = element_blank(), # Removes axis line,
        legend.position = "top", # bottom, top, right, left
        # legend.key = element_rect(size = 15), # Legend box size
        # legend.key.height =unit(1,"line"),
        # legend.key.width =unit(1,"line"),
        legend.background = element_rect(),
        legend.text = element_text(size = 18), #Legend text size
        legend.title = element_blank(), # Legend title size
        strip.background = element_blank(), #Facewrap options
        strip.text = element_text(size = 20)
  ) 



```

```{r GB_Results_All, eval=F, echo = F}

#### Filter Species  ####

Atlantic_Species <- c(
  "Gadus morhua",  # Cod
  "Limanda ferruginea", # Yellowtail flounder
  "Melanogrammus aeglefinus"
)

# Run Spatial chuck for the Atlantic
# NAFO_5z$geometry

Atlantic_DBEM <- DBEM_Results %>% 
  filter(Species %in% Atlantic_Species) %>% 
  filter( # Limit the area to George's bank
    Latitude < 45.9759, # North
    Latitude > 35, # South 
    Longitude > -71.0592, # West
    Longitude < -63.33333
  )

# Path for saving plots
Path <- "/Users/jpalacios/Documents/UBC/Oceans_Project/Manuscript/Results/GB/All"


### MCP Change Analysis ####

for(r in 1:2){
  
  if(r == 1){
    RCP = c("GFDL26F1","IPSL26F1","MPI26F1") #Low RCP
  }else{
    RCP = c("GFDL85F1","IPSL85F1","MPI285F1") #High RCP
  }
  
  # Mean for each cel from 2004-2014
  Mean_Data <- Atlantic_DBEM %>% 
    filter(Model %in% RCP) %>% 
    group_by(INDEX,
             Model) %>% 
    summarise_at(vars(`2005`:`2099`), sum,na.rm=T) %>% 
    select(INDEX,`2005`:`2014`) %>% 
    group_by(INDEX) %>% 
    summarise_at(vars(`2005`:`2014`), mean,na.rm=T) %>% 
    mutate(Mean = rowMeans(.[,2:11])) %>%
    # mutate(SD = rowSds(.[,2:11])) %>%
    select(INDEX,Mean) %>% 
    arrange(INDEX)
  
  #The future
  Future <- Atlantic_DBEM %>% 
    filter(Model %in% RCP) %>% 
    group_by(INDEX,
             Model) %>% 
    summarise_at(vars(`2005`:`2099`), sum,na.rm=T) %>% 
    group_by(INDEX) %>% 
    summarise_at(vars(`2015`:`2099`), mean,na.rm=T) %>% 
    arrange(INDEX)
  
  # #Devide one by the other
  Cell_Index <- sweep(Future[2:86],#Future catch p.
                      1, #1 goes by row and 2 goes by colum
                      Mean_Data$Mean, #the means
                      "/") %>% 
    mutate(INDEX = Future$INDEX) %>% 
    select(INDEX,everything()) %>% 
    left_join(GB_Coor, #And now we include Lat-Long
              by="INDEX")
  
  Mid_Century <- Cell_Index %>% 
    select(INDEX,
           `2046`:`2055`) %>% 
    mutate(Mean = rowMeans(.[,2:11])) %>% 
    left_join(GB_Coor,
              by ="INDEX") %>% 
    mutate(Percentage = round(-(1-Mean)*100)) %>% # Convert to percentage
    mutate("Percentage Change" = ifelse(Percentage > 100, 100,Percentage)) %>%  # set everything over 100 to 
    filter(!is.na(Longitude)) %>% 
    filter(Latitude <= 50)
  
  Mid_Century$Bins <- cut(Mid_Century$Percentage,breaks = 5)
  
  
  # _______________________________________________________
  
  # The plot 
  
  # Lim_Neg <- min(Seq)
  # Lim_Max <- max(Seq)
  
  ggplot() +
    geom_tile(data = Mid_Century,
              aes(
                x = Longitude,
                y = Latitude,
                # fill = Percentage,
                # colour = Percentage
                fill = reorder(Bins,-Percentage),
                colour = reorder(Bins,-Percentage)
              )
    ) +
    scale_color_brewer("MCP % Change",type='seq', palette='Reds') +
    scale_fill_brewer("MCP % Change",type='seq', palette='Reds') +
    # scale_fill_gradient2(limits=c(Lim_Neg, # If not using the bins
    #                               Lim_Max),
    #                      breaks = Seq#,
    #                      ) +
    # scale_colour_gradient2(limits=c(Lim_Neg,
    #                                 Lim_Max),
    #                        breaks = Seq#,
    #                        ) +
    geom_sf(data = GM_Land, colour = "lightgrey") +
    geom_sf(data = eez_GM, fill = NA) +
    annotate("text", label = "United States", x = -70, y = 45, size = 4, colour = "black") +
    annotate("text", label = "Canada", x = -66.7, y = 45.4, size = 4, colour = "black") +
    annotate("text", label = "Canada", x = -65.4, y = 44.2, size = 4, colour = "black") +
    coord_sf(xlim = c(-71.0592, -63.33333),
             ylim = c(40.5,45.5)
    ) +
    ggtheme_map() +
    theme(
      axis.line = element_line(colour = "black", size = .5),
      axis.ticks = element_line(size = .5),
      axis.text.x = element_text(size = 12,
                                 angle = 0,
                                 face = "plain"),
      axis.text.y = element_text(size = 12)
    )
  
  
  if(r == 1){
    Name = paste("Change_GB_26_2050.png")
  }else{
    Name = paste("Change_GB_85_2050.png")
  }
  
  ggsave(Name,
         plot = last_plot(),
         width = 8,
         height = 7,
         units = "in",
         path = Path)
  
  
  ### now we average the results from the models for END century ###
  
  End_Century <- Cell_Index %>% 
    select(INDEX,
           `2090`:`2099`) %>% 
    mutate(Mean = rowMeans(.[,2:11])) %>% 
    left_join(GB_Coor,
              by ="INDEX")%>% 
    mutate(Percentage = round(-(1-Mean)*100)) %>% # Convert to percentage
    mutate("Percentage Change" = ifelse(Percentage > 100, 100,Percentage)) %>% # set everything over 100 to 100
    filter(!is.na(Longitude)) %>% 
    filter(Latitude <= 50)
  
  
  End_Century$Bins <- cut(End_Century$Percentage,breaks = 5)
  
  
  # _______________________________________________________
  
  # The plot 
  
  
  ggplot() +
    geom_tile(data = End_Century,
              aes(
                x = Longitude,
                y = Latitude,
                # fill = Percentage,
                # colour = Percentage
                fill = reorder(Bins,-Percentage),
                colour = reorder(Bins,-Percentage)
              )
    ) +
    scale_color_brewer("MCP % Change",type='seq', palette='Reds') +
    scale_fill_brewer("MCP % Change",type='seq', palette='Reds') +
    # scale_fill_gradient2(limits=c(Lim_Neg, # If not using the bins
    #                               Lim_Max),
    #                      breaks = Seq#,
    #                      ) +
    # scale_colour_gradient2(limits=c(Lim_Neg,
    #                                 Lim_Max),
    #                        breaks = Seq#,
    #                        ) +
    geom_sf(data = GM_Land, colour = "lightgrey") +
    geom_sf(data = eez_GM, fill = NA) +
    annotate("text", label = "United States", x = -70, y = 45, size = 4, colour = "black") +
    annotate("text", label = "Canada", x = -66.7, y = 45.4, size = 4, colour = "black") +
    annotate("text", label = "Canada", x = -65.4, y = 44.2, size = 4, colour = "black") +
    coord_sf(xlim = c(-71.0592, -63.33333),
             ylim = c(40.5,45.5)
    ) +
    ggtheme_map() +
    theme(
      axis.line = element_line(colour = "black", size = .5),
      axis.ticks = element_line(size = .5),
      axis.text.x = element_text(size = 12,
                                 angle = 0,
                                 face = "plain"),
      axis.text.y = element_text(size = 12)
    )
  
  if(r == 1){
    Name_End = paste("Change_GB_26_2100.png")
  }else{
    Name_End = paste("Change_GB_85_2100.png")
  }
  
  ggsave(Name_End,
         plot = last_plot(),
         width = 6,
         height = 5,
         units = "in",
         path = Path)
  
} # Close overall production loop

### Proportion change gom 

#### Filter EEZs ###

GB_Absolutes <- Atlantic_DBEM %>%
  mutate(RCP = ifelse(Model %in% c("GFDL26F1","IPSL26F1","MPI26F1"),"RCP 2.6","RCP 8.5")) %>%  # Assigns RCP by model
  filter(Species %in% Atlantic_Species,
         INDEX %in% GB_Coor$INDEX) %>%  #Selects only IPHC species within regulatory areas
  left_join(EEZsID,
            by = "INDEX") %>% 
  gather("Year","MCP",`2005`:`2099`) %>%
  group_by(RCP,Name,Year,Model,Species) %>%
  summarise(Total_MCP = sum(MCP, na.rm = T)) #%>% # Sums INDEX MCP per EEZ
  # group_by(RCP,Name,Year,Species) %>%
  # summarise(Mean_MCP = mean(Total_MCP, na.rm = T), #Yearly mean per ESM model
  #           SD_MCP = sd(Total_MCP, na.rm = )
  # )


# Changes in the proportion in comparrison of the mean (2004-2014) proportion ####

Proportion_Total <- GB_Absolutes %>% 
  group_by(RCP,Year,Species,Model) %>% 
  summarise(
    Total = sum(Total_MCP)
  )

# head(Proportion_Total)

Proportion_Change <- GB_Absolutes %>% 
  left_join(Proportion_Total,
            by = c("RCP","Year","Species","Model")) %>% 
  mutate(Proportion = (Total_MCP/Total)*100)

Early_Proportion <- Proportion_Change %>% 
  filter(Year <= 2014) %>% 
  # group_by(RCP,
  #          Name) %>%
  group_by(RCP,Name,Species,Model) %>%  # Species test
  summarise(Mean_Prop = mean(Proportion))

Proportion_Change <- GB_Absolutes %>% 
  left_join(Proportion_Total,
            by = c("RCP","Year","Species","Model")) %>% 
  mutate(Proportion = (Total_MCP/Total)*100) %>% 
  left_join(Early_Proportion,
            by= c("RCP",
                  "Name",
                  "Species",
                  "Model")) %>% 
  mutate(Change = Proportion/Mean_Prop) %>% 
  mutate(Percentage = round(-(1-Change)*100,2)) %>% 
  arrange(RCP)

#### The actual plot ####

### Box plot ###

PL <- Proportion_Change %>% 
  mutate(Time_Step = ifelse(Year >= 2046 & Year <= 2055,"Mid Century",
                            ifelse(Year >= 2089,"End Century","NA"))) %>% 
  filter(Time_Step == "Mid Century",
         RCP == "RCP 2.6") %>% 
  ggplot(.,
         aes(
           # x = Species,
             x = reorder(Species,Percentage, FUN = median), # from forcasts` package
             # x = (Time_Step), # from forcasts` package
             y = Percentage,
             fill = Name
         )
  ) +
  geom_boxplot() +
  ylab("") +
  xlab ("") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  ggtheme_plot() +
   ylim(-10, 10) +
scale_fill_brewer("Region",palette = "Set2") + 
  geom_label(data=Proportion_Change, 
             aes(label = "RCP 2.6",
                 x = "Melanogrammus aeglefinus", 
                 y = 10,
                 fill = NA), #RCP labels for grid plot
             colour = "blue",
             show.legend = FALSE,
             size = 5,
             hjust = 1.5
  ) +
  theme(legend.position = c(0.2, 0.98),
        legend.direction = "horizontal",
        axis.text.x = element_text(size = 10,
                               angle = 0,
                               face = "italic")
  )

PH <- Proportion_Change %>%
  mutate(Time_Step = ifelse(Year >= 2046 & Year <= 2055,"Mid Century",
                            ifelse(Year >= 2089,"End Century","NA"))) %>% 
  filter(Time_Step == "Mid Century",
         RCP == "RCP 8.5") %>% 
  ggplot(.,
         aes(
           # x = Species,
             x = reorder(Species,Percentage, FUN = median), # from forcasts` package
             # x = (Time_Step), # from forcasts` package
             y = Percentage,
             fill = Name
         )
  ) +
  geom_boxplot() +
  ylab("") +
  xlab ("") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  ggtheme_plot() +
  theme(
         axis.text.x = element_text(size = 10,
                               angle = 0,
                               face = "italic")
  ) +
scale_fill_brewer("Region",palette = "Set2",guide=FALSE) + 
  geom_label(data=Proportion_Change, aes(label = "RCP 8.5", x = "Melanogrammus aeglefinus", y = 10, fill = NA), #RCP labels for grid plot
             colour = "red",
             show.legend = FALSE,
             size = 5,
             hjust = 1.5
  )

ggdraw() +
  draw_plot(PL, x = 0, y = 0.5, width = 1, height = 0.5) +
  draw_plot(PH, x = 0, y = 0, width = 1, height = 0.5) +
  draw_plot_label(label = c("A", "B"), size = 15,
                  x = c(0, 0), 
                  y = c(1, 0.5)) +
  draw_plot_label(label = "Stock-share percentage change",
                  size = 12, angle = 90, fontface = "plain",
                  x = 0.02,
                  y =0.11999)


ggsave("Fig6.png",
       plot = last_plot(),
       width = 8,
       height = 6,
       units = "in",
       path = Path)


```